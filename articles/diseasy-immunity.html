<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>DiseasyImmunity • diseasy</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="DiseasyImmunity">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">diseasy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/diseasy.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Creating ensembles</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-ensembles.html">Creating ensembles</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Functional modules</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasy-activity.html">DiseasyActivity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-immunity.html">DiseasyImmunity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-observables.html">DiseasyObservables</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-season.html">DiseasySeason</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-variant.html">DiseasyVariant</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Model templates</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasy-model-ode.html">DiseasyModelOde</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-model-regression.html">DiseasyModelRegression</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Developer guides</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-a-model.html">Creating a model</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Model notes</h6></li>
    <li><a class="dropdown-item" href="../articles/SEIR-implementation.html">SEIR: Implementation</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-initialisation.html">SEIR: Initialising from incidence data</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-malthusian-matching.html">SEIR: Accounting for structural differences in malthusian growth rates</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Additional information</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasy-immunity-optimisation.html">DiseasyImmunity optimisation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ssi-dk/diseasy/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>DiseasyImmunity</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ssi-dk/diseasy/blob/main/vignettes/articles/diseasy-immunity.Rmd" class="external-link"><code>vignettes/articles/diseasy-immunity.Rmd</code></a></small>
      <div class="d-none name"><code>diseasy-immunity.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ssi-dk/diseasy" class="external-link">diseasy</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: diseasystore</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'diseasy'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:diseasystore':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     diseasyoption</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code><a href="../reference/DiseasyImmunity.html">?DiseasyImmunity</a></code> is a module designed to implement
various models for the waning of immunity against a disease.</p>
</div>
<div class="section level2">
<h2 id="configuring-the-module">Configuring the module<a class="anchor" aria-label="anchor" href="#configuring-the-module"></a>
</h2>
<p>The module can be initialized without setting any parameters, with
the following code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/DiseasyImmunity.html">DiseasyImmunity</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="inspecting-the-module">Inspecting the module<a class="anchor" aria-label="anchor" href="#inspecting-the-module"></a>
</h2>
<p>By default, the module initializes with the <code>no_waning</code>
model (that is, constant, full immunity) stored under the target
“infection”.</p>
<p>To check the currently set targets and associated models, you can use
the following code.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="co">#&gt; $infection</span></span>
<span><span class="co">#&gt; function (t) </span></span>
<span><span class="co">#&gt; 1</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55e47a613938&gt;</span></span>
<span><span class="co">#&gt; attr(,"name")</span></span>
<span><span class="co">#&gt; [1] "no_waning"</span></span></code></pre></div>
<p>This returns a <code>named list()</code> where the named target are
modelled by the corresponding function.</p>
<p>To see the available waning models within the module, query the
module as shown below:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span><span class="op">$</span><span class="va">available_waning_models</span></span>
<span><span class="co">#&gt; [1] "custom_waning"      "exponential_waning" "heaviside_waning"  </span></span>
<span><span class="co">#&gt; [4] "linear_waning"      "no_waning"          "sigmoidal_waning"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setting-a-waning-model-in-the-module">Setting a waning model in the module<a class="anchor" aria-label="anchor" href="#setting-a-waning-model-in-the-module"></a>
</h2>
<p>The input for the predefined waning models include:</p>
<ul>
<li>
<code>target</code>: The specific aspect towards which immunity is
waning, such as “infection”.</li>
<li>
<code>time_scale</code>: A characteristic time scale, which defines
the period until when the immunity is significantly waning. Note that
the <code>no_waning</code> model does not have a time scale
parameter.</li>
</ul>
<p>The name of the chosen target is arbitrary within the context of the
<code><a href="../reference/DiseasyImmunity.html">?DiseasyImmunity</a></code> module, but models within the
<code>diseasy</code> framework may expect named targets such as
“infection”, “hospitalisation”, or “death”.</p>
<p>Here is an example of how to set the exponential waning model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span><span class="op">$</span><span class="fu">set_sigmoidal_waning</span><span class="op">(</span>time_scale <span class="op">=</span> <span class="fl">9</span>, target <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $infection</span></span>
<span><span class="co">#&gt; function (t) </span></span>
<span><span class="co">#&gt; exp(-(t - time_scale)/shape)/(1 + exp(-(t - time_scale)/shape))</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55e47bd26188&gt;</span></span>
<span><span class="co">#&gt; attr(,"name")</span></span>
<span><span class="co">#&gt; [1] "sigmoidal_waning"</span></span>
<span><span class="co">#&gt; attr(,"dots")</span></span>
<span><span class="co">#&gt; attr(,"dots")$time_scale</span></span>
<span><span class="co">#&gt; [1] 9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"dots")$shape</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
<p>To inspect that the model has been set correctly use
<code>im$model</code></p>
<p>To visualize the model, the plot function provided by the module can
be used:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span></span></code></pre></div>
<p><img src="diseasy-immunity_files/figure-html/plot_1-1.png" class="r-plt" alt="Visualisation of a exponentially waning immunity against infection." width="700"></p>
<p>Besides the predefined functions, you can also create a custom waning
function.</p>
<p>The input for the custom waning function includes:</p>
<ul>
<li>
<code>custom_function</code>: A function defining how immunity wanes
over time. It should take time (t) as a parameter and also include
<code>time_scale</code> in the function expression.</li>
<li>
<code>time_scale</code>: A characteristic time scale, which defines
the period until when the immunity is significantly waning.</li>
<li>
<code>target</code>: The specific aspect towards which immunity is
waning, such as e.g. infection, hospitalisation, or death.</li>
<li>
<code>name</code>: A name for the custom function, used for
identification. Default is “custom_waning”.</li>
</ul>
<p>Here is an example of setting a custom waning function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span><span class="op">$</span><span class="fu">set_custom_waning</span><span class="op">(</span></span>
<span>  custom_function <span class="op">=</span> \<span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fl">0.8</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span> <span class="op">(</span><span class="va">t</span> <span class="op">/</span> <span class="va">time_scale</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.2</span>,</span>
<span>  time_scale <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  target <span class="op">=</span> <span class="st">"hospitalisation"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"gaussian_waning"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $hospitalisation</span></span>
<span><span class="co">#&gt; function (t) </span></span>
<span><span class="co">#&gt; 0.8 * exp(-(t/time_scale)^2) + 0.2</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55e47caf1400&gt;</span></span>
<span><span class="co">#&gt; attr(,"name")</span></span>
<span><span class="co">#&gt; [1] "gaussian_waning"</span></span>
<span><span class="co">#&gt; attr(,"dots")</span></span>
<span><span class="co">#&gt; attr(,"dots")$time_scale</span></span>
<span><span class="co">#&gt; [1] 12</span></span></code></pre></div>
<p>To visualize all the functions in the model, use the same plot
function as above:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span></span></code></pre></div>
<p><img src="diseasy-immunity_files/figure-html/plot_2-1.png" class="r-plt" alt="Visualising the additional custom (sigmoid) waning immunity against hospitalisation." width="700"></p>
<div class="section level3">
<h3 id="setting-the-waning-model-programmatically">Setting the waning model programmatically<a class="anchor" aria-label="anchor" href="#setting-the-waning-model-programmatically"></a>
</h3>
<p><code><a href="../reference/DiseasyImmunity.html">?DiseasyImmunity</a></code> also provides the
<code><a href=".{2}/reference/DiseasyImmunity.html#method-DiseasyImmunity-set_waning_model">$set_waning_model()</a></code> function which allows
greater flexibility when configuring various waning models within the
module.</p>
<p><code><a href=".{2}/reference/DiseasyImmunity.html#method-DiseasyImmunity-set_waning_model">$set_waning_model()</a></code> provides a single
entry-point for setting the predefined waning models or a custom waning
function based on the specified <code>model</code> and
<code>target</code>.</p>
<p>If <code>model</code> is a <code>function</code>, it will be set as a
custom waning function via
<code><a href=".{2}/reference/DiseasyImmunity.html#method-DiseasyImmunity-set_custom_waning">$set_custom_waning()</a></code>. If instead it is
<code>character</code>, the corresponding to
<code>$set_&lt;model&gt;()</code> method will be used to set the waning
model.</p>
<p>Input for both predefined models and custom waning functions can be
passed to the <code><a href=".{2}/reference/DiseasyImmunity.html#method-DiseasyImmunity-set_waning_model">$set_waning_model()</a></code> as
additional arguments.</p>
<p>An example of how to set the two model examples from above, using the
<code><a href=".{2}/reference/DiseasyImmunity.html#method-DiseasyImmunity-set_waning_model">$set_waning_model()</a></code> is as follows:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span><span class="op">$</span><span class="fu">set_waning_model</span><span class="op">(</span>model <span class="op">=</span> <span class="st">"sigmoidal_waning"</span>, time_scale <span class="op">=</span> <span class="fl">9</span>, target <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $infection</span></span>
<span><span class="co">#&gt; function (t) </span></span>
<span><span class="co">#&gt; exp(-(t - time_scale)/shape)/(1 + exp(-(t - time_scale)/shape))</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55e47def4f10&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55e47d9fc1f0&gt;</span></span>
<span><span class="co">#&gt; attr(,"name")</span></span>
<span><span class="co">#&gt; [1] "sigmoidal_waning"</span></span>
<span><span class="co">#&gt; attr(,"dots")</span></span>
<span><span class="co">#&gt; attr(,"dots")$time_scale</span></span>
<span><span class="co">#&gt; [1] 9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"dots")$shape</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="va">im</span><span class="op">$</span><span class="fu">set_waning_model</span><span class="op">(</span></span>
<span>  model <span class="op">=</span> \<span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fl">0.8</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span> <span class="op">(</span><span class="va">t</span> <span class="op">/</span> <span class="va">time_scale</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.2</span>,</span>
<span>  time_scale <span class="op">=</span> <span class="fl">18</span>,</span>
<span>  target <span class="op">=</span> <span class="st">"hospitalisation"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"gaussian_waning"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $hospitalisation</span></span>
<span><span class="co">#&gt; function (t) </span></span>
<span><span class="co">#&gt; 0.8 * exp(-(t/time_scale)^2) + 0.2</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55e47e695dd0&gt;</span></span>
<span><span class="co">#&gt; attr(,"name")</span></span>
<span><span class="co">#&gt; [1] "gaussian_waning"</span></span>
<span><span class="co">#&gt; attr(,"dots")</span></span>
<span><span class="co">#&gt; attr(,"dots")$time_scale</span></span>
<span><span class="co">#&gt; [1] 18</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="changing-the-time-scale">Changing the time scale<a class="anchor" aria-label="anchor" href="#changing-the-time-scale"></a>
</h2>
<p>It is also possible to change the characteristic time scale after
setting the model.</p>
<p>This is done via the method
<code><a href=".{2}/reference/DiseasyImmunity.html#method-DiseasyImmunity-set_time_scales">$set_time_scales()</a></code> which takes a named list
as input and changes time scales of waning functions associated with the
named targets.</p>
<p>Following is an example of how to change the time scale for the two
targets in the current models.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span><span class="op">$</span><span class="fu">set_time_scales</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"infection"</span> <span class="op">=</span> <span class="fl">6</span>, <span class="st">"hospitalisation"</span> <span class="op">=</span> <span class="fl">18</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $infection</span></span>
<span><span class="co">#&gt; function (t) </span></span>
<span><span class="co">#&gt; exp(-(t - time_scale)/shape)/(1 + exp(-(t - time_scale)/shape))</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55e47d9fc1f0&gt;</span></span>
<span><span class="co">#&gt; attr(,"name")</span></span>
<span><span class="co">#&gt; [1] "sigmoidal_waning"</span></span>
<span><span class="co">#&gt; attr(,"dots")</span></span>
<span><span class="co">#&gt; attr(,"dots")$time_scale</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $hospitalisation</span></span>
<span><span class="co">#&gt; function (t) </span></span>
<span><span class="co">#&gt; 0.8 * exp(-(t/time_scale)^2) + 0.2</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55e47e695dd0&gt;</span></span>
<span><span class="co">#&gt; attr(,"name")</span></span>
<span><span class="co">#&gt; [1] "gaussian_waning"</span></span>
<span><span class="co">#&gt; attr(,"dots")</span></span>
<span><span class="co">#&gt; attr(,"dots")$time_scale</span></span>
<span><span class="co">#&gt; [1] 18</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="approximating-to-a-compartmental-model">Approximating to a compartmental model<a class="anchor" aria-label="anchor" href="#approximating-to-a-compartmental-model"></a>
</h2>
<p><code><a href="../reference/DiseasyImmunity.html">?DiseasyImmunity</a></code> can also provide the approximations of
the waning models for compartmental ODE models. (e.g. the
Susceptible-Infected-Recovered-Susceptible (SEIR) models).</p>
<p>The approximation assumes the model has a number of sequential R
compartments
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mn>1</mn></msub><mi>.</mi><mi>.</mi><mo>,</mo><msub><mi>R</mi><mi>M</mi></msub></mrow><annotation encoding="application/x-tex">R_1 .., R_M</annotation></semantics></math>)
and then provides the transition rates and associated risks for each
compartment that best approximates set waning functions (see Figure 1
for a illustration).</p>
<div class="float">
<img src="article_data/diseasy-immunity-model-structure.png" alt="Figure 1: Illustration of the compartmental model structure."><div class="figcaption">Figure 1: Illustration of the compartmental
model structure.</div>
</div>
<p>Some definitions:</p>
<ul>
<li>Flow between compartments: The transition rate between compartments
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">m+1</annotation></semantics></math>
is defined as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\delta_m</annotation></semantics></math>.</li>
<li>Risk associated with compartments: The protective effect associated
with compartment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
is defined as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>,
which represents the probability of not becoming infected when exposed
to an infected individual.</li>
<li>In <code><a href="../reference/DiseasyImmunity.html">?DiseasyImmunity</a></code> we operate with multiple targets,
so we have a set of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>
values for each target, but only a single set of transition rates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\delta_m</annotation></semantics></math>.</li>
</ul>
<p>Combined, these rates and risks define a population level waning
immunity. From the waiting time distributions, hypoexponential in
general, Erlang distributed if all rates are equal, we can compute the
probability to occupy each compartment at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
after entering the first compartment at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t = 0</annotation></semantics></math>.
We denote this probability as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">P</mtext><mi>m</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mspace width="0.278em"></mspace><mo stretchy="false" form="prefix">|</mo><mspace width="0.278em"></mspace><mover><mi>δ</mi><mo accent="true">→</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\textrm{P}_m(t \;|\;\vec{\delta})</annotation></semantics></math>.
Given this occupancy probability, we can parametrise the approximated
waning immunity of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>th
target as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover><mi>f</mi><mo accent="true">̃</mo></mover><mi>k</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>≡</mo><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msubsup><mi>γ</mi><mi>m</mi><mi>k</mi></msubsup><mspace width="0.278em"></mspace><msub><mtext mathvariant="normal">P</mtext><mi>m</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mspace width="0.278em"></mspace><mo stretchy="false" form="prefix">|</mo><mspace width="0.278em"></mspace><mover><mi>δ</mi><mo accent="true">→</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\tilde{f}^k(t) \equiv \sum_{m = 1}^M \gamma_m^k\; \textrm{P}_m(t\;|\;\vec{\delta})
</annotation></semantics></math></p>
<p>Three approaches are available for determining the transition rates,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\delta_m</annotation></semantics></math>,
and protective effect,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>,
that best approximates the set waning functions:</p>
<ul>
<li><p>Method 1 (<code>free_gamma</code>):
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>
values are allowed to vary freely, while the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\delta_m</annotation></semantics></math>
rates are equal between compartments
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>δ</mi><mi>m</mi></msub><mo>=</mo><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta_m = \delta</annotation></semantics></math>).</p></li>
<li><p>Method 2 (<code>free_delta</code>):
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>
values are linearly distributed from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(0)</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>∞</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(\infty)</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\delta_m</annotation></semantics></math>
are allowed to vary freely.</p></li>
<li><p>Method 3 (<code>all_free</code>): Both
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\delta_m</annotation></semantics></math>
are allowed to vary freely.</p></li>
</ul>
<p>In addition, there are three strategies for the initial guess of the
parameters:</p>
<ul>
<li><p>Strategy 1 (<code>naive</code>): The initial guess that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>
values are linearly distributed from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(0)</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>∞</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(\infty)</annotation></semantics></math>,
while the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\delta_m</annotation></semantics></math>
values are assumed to be set by the reciprocal of the median time scale
of the targets.</p></li>
<li><p>Strategy 2 (<code>recursive</code>): The initial guess is based
on the previous optimisation results for <code>M - 1</code>.</p></li>
<li><p>Strategy 3 (<code>combination</code> - only for the
<code>all_free</code> method): The initial guess uses the solution from
strategy 1.</p></li>
</ul>
<p>The parameters of the approximation are then determined through the
use of an optimiser (controllable via the <code>optim_control</code>
argument), which minimises the sum of the square roots of the
differences between the target and approximation functions plus
additional penalties for the parameters:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">objective</mtext><mo>=</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msqrt><mrow><msubsup><mo>∫</mo><mn>0</mn><mi>∞</mi></msubsup><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>f</mi><mi>k</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msup><mover><mi>f</mi><mo accent="true">̃</mo></mover><mi>k</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow></msqrt><mo>+</mo><mtext mathvariant="normal">penalty</mtext></mrow><annotation encoding="application/x-tex">
 \textrm{objective} = \sum_{k = 1}^K \sqrt{\int_0^\infty \left( f^k(t) - \tilde{f}^k(t) \right)^2} + \textrm{penalty}
</annotation></semantics></math></p>
<p>where the penalties are controllable via the <code>monotonous</code>
and <code>individual_level</code> arguments:</p>
<ul>
<li><p><code>monotonous</code>: A penalty for non-monotonous
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>
values is added.</p></li>
<li><p><code>individual_level</code>: A penalty variation in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\delta_m</annotation></semantics></math>
values are added. The population level waning immunity may be smoothly
changing for a set of parameters, but the instantaneous change in
immunity between two neighbouring compartments may be large. This
penalty can be added to avoid such behaviour and soften transitions
between states.</p></li>
</ul>
<p>The input for the
<code><a href=".{2}/reference/DiseasyImmunity.html#method-DiseasyImmunity-approximate_compartmental">$approximate_compartmental()</a></code> function
includes:</p>
<ul>
<li>
<code>method</code>: One of the methods from above - “free_gamma”,
“free_delta” or “all_free”.</li>
<li>
<code>strategy</code>: One of the strategies from above - “naive”,
“recursive” or “combination” (optional).</li>
<li>
<code>M</code>: The number of compartments to use for the
approximation.</li>
<li>
<code>optim_control</code>: A configuration of the optimiser
(optional). The approximation to the compartmental model is a hard
optimisation problem where the choice of the optimiser can have a
significant impact on the quality of the fit. See
<code>vignette("diseasy-immunity-optimisation")</code> for more
information on the optimiser configuration.</li>
</ul>
<p>In this example, the module contains the infection and
hospitalisation targets defined earlier, which will be approximated.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span><span class="op">$</span><span class="fu">approximate_compartmental</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"free_gamma"</span>, M <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1]  0.9825592  0.3443457 -1.5147353 39.9186534 44.9819378 36.6750318 -1.5891168</span></span>
<span><span class="co">#&gt; attr(,"status")</span></span>
<span><span class="co">#&gt; [1] " " " " " " " " " " " " " "</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 0.2235232</span></span>
<span><span class="co">#&gt; attr(,"fname")</span></span>
<span><span class="co">#&gt; function(p) sum(obj_function(p))</span></span>
<span><span class="co">#&gt; attr(,"method")</span></span>
<span><span class="co">#&gt; [1] "hjkb"</span></span>
<span><span class="co">#&gt; attr(,"ptype")</span></span>
<span><span class="co">#&gt; [1] "U"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $niter</span></span>
<span><span class="co">#&gt; [1] 19</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; [1] 1756   NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $scounts</span></span>
<span><span class="co">#&gt; [1] 1756    0    0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $gamma</span></span>
<span><span class="co">#&gt; $gamma$infection</span></span>
<span><span class="co">#&gt; [1] 0.7276157 0.5852458 0.1802381 0.0000000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $gamma$hospitalisation</span></span>
<span><span class="co">#&gt; [1] 1.0 1.0 1.0 0.2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $delta</span></span>
<span><span class="co">#&gt; [1] 0.1857372 0.1857372 0.1857372</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $method</span></span>
<span><span class="co">#&gt; [1] "free_gamma"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $strategy</span></span>
<span><span class="co">#&gt; [1] "naive"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $M</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $error</span></span>
<span><span class="co">#&gt; [1] 0.1422456</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $penalty</span></span>
<span><span class="co">#&gt; [1] 0.08127767</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $execution_time</span></span>
<span><span class="co">#&gt; Time difference of 4.951481 mins</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"maximize")</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>To visualize how the approximations compare to the target functions,
the plot function can be used. Simply specify the approach and the
number of compartments (<code>M</code>). The plot will display both the
approximations and the target functions for comparison.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"free_gamma"</span>, M <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="diseasy-immunity_files/figure-html/plot%20approximation-1.png" class="r-plt" alt="Visualisation of the approximations of the waning models." width="700"></p>
<div class="section level3">
<h3 id="the-effect-of-penalties">The effect of penalties<a class="anchor" aria-label="anchor" href="#the-effect-of-penalties"></a>
</h3>
<p>By default, a small penalty is added to encourage monotonous
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>
values and smooth transitions between compartments. This worsens the
absolute fit to the target functions, but means that the waning of
immunity can be interpreted at the individual level rather than
population level.</p>
<p>To see this in effect, we run the approximation with and without the
penalties and plot the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>
over time<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;“time” here is the expectation value of the time of the
transition to the compartment with the given value of
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mi&gt;γ&lt;/mi&gt;&lt;annotation encoding="application/x-tex"&gt;\gamma&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/p&gt;'><sup>1</sup></a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Retrieve gamma and delta values for both cases</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  \<span class="op">(</span><span class="va">penalty</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">approx</span> <span class="op">&lt;-</span> <span class="va">im</span><span class="op">$</span><span class="fu">approximate_compartmental</span><span class="op">(</span></span>
<span>      method <span class="op">=</span> <span class="st">"all_free"</span>,</span>
<span>      M <span class="op">=</span> <span class="fl">4</span>,</span>
<span>      monotonous <span class="op">=</span> <span class="va">penalty</span>,</span>
<span>      individual_level <span class="op">=</span> <span class="va">penalty</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      <span class="st">"gamma"</span> <span class="op">=</span> <span class="va">approx</span><span class="op">$</span><span class="va">gamma</span><span class="op">$</span><span class="va">infection</span>,</span>
<span>      <span class="st">"delta"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">approx</span><span class="op">$</span><span class="va">delta</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>      <span class="st">"penalty"</span> <span class="op">=</span> <span class="va">penalty</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">results</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="st">"t"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">delta</span>, default <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="st">"penalty"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">gamma</span>, color <span class="op">=</span> <span class="va">penalty</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="st">"gamma"</span>, color <span class="op">=</span> <span class="st">"Penalty?"</span><span class="op">)</span></span></code></pre></div>
<p><img src="diseasy-immunity_files/figure-html/effect%20of%20penalty-1.png" class="r-plt" alt="Adding penalty to approximations smoothens the transitions between compartments." width="700"></p>
<p>With the penalties imposed, the steps in the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>
values are smaller than if the penalties are not imposed.</p>
</div>
</div>
<div class="section level2">
<h2 id="compartment-selection-elbow-curve-method">Compartment selection (elbow curve method)<a class="anchor" aria-label="anchor" href="#compartment-selection-elbow-curve-method"></a>
</h2>
<p>The accuracy of the approximation can be influenced by the number of
compartments (<code>M</code>) used in the model. Therefore it is crucial
to select the right <code>M</code>, as too few compartments can lead to
poor approximation, while too many compartments can lead to unnecessary
computational time without significant improvement in accuracy. The
elbow curve method is employed to determine the appropriate
<code>M</code> for the models. Each approach is executed across a range
of <code>M</code> values, and the resulting objective function values
are returned as <code>value</code> from the
<code><a href=".{2}/reference/DiseasyImmunity.html#method-DiseasyImmunity-approximate_compartmental">$approximate_compartmental()</a></code> function.</p>
<p>In the example below, we have a case where the “all_free” method
outperforms the other methods, but this is not generally true. We find
that the “all_free” method can be the best if the problem contains
multiple time scales, but often performs no better than “free_gamma”.
For more examples, see the optimisation vignette
(<code>vignette("diseasy-immunity-optimisation")</code>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare the data</span></span>
<span><span class="va">M_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">1</span>, to <span class="op">=</span> <span class="fl">5</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"free_gamma"</span>, <span class="st">"free_delta"</span>, <span class="st">"all_free"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run each function</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="va">methods</span>,</span>
<span>  M <span class="op">=</span> <span class="va">M_seq</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>    \<span class="op">(</span><span class="va">method</span>, <span class="va">M</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">im</span><span class="op">$</span><span class="fu">approximate_compartmental</span><span class="op">(</span>method <span class="op">=</span> <span class="va">method</span>, M <span class="op">=</span> <span class="va">M</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    .progress <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/list_transpose.html" class="external-link">list_transpose</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">M</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"M"</span>, y <span class="op">=</span> <span class="st">"Error"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span></span>
<span>    xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">M</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    expand <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="diseasy-immunity_files/figure-html/elbow%20curve%20method-1.png" class="r-plt" alt="Increasing number of compartments has diminishing returns on the error." width="700"></p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rasmus Skytte Randløv, Lasse Engbo Christiansen, Kaare Græsbøll, Sofia Myrup Otero, Marcus Munch Grünewald, <a href="https://www.ssi.dk/" class="external-link"><img src="https://www.ssi.dk/assets/images/ssi-logo-optimeret.svg" alt="SSI" height="64" style="margin-bottom: 0.5em; margin-top: 1.5em;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
