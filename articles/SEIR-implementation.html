<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>SEIR: Implementation • diseasy</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="SEIR: Implementation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">diseasy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/diseasy.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Creating ensembles</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-ensembles.html">Creating ensembles</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Functional modules</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasy-activity.html">DiseasyActivity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-immunity.html">DiseasyImmunity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-observables.html">DiseasyObservables</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-season.html">DiseasySeason</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-variant.html">DiseasyVariant</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Model templates</h6></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Developer guides</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-a-model.html">Creating a model</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Model notes</h6></li>
    <li><a class="dropdown-item" href="../articles/SEIR-implementation.html">SEIR: Implementation</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-initialisation.html">SEIR: Initialising from incidence data</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-malthusian-matching.html">SEIR: Accounting for structural differences in malthusian growth rates</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Additional information</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-a-model.html">Creating a model</a></li>
    <li><a class="dropdown-item" href="../articles/creating-ensembles.html">Creating ensembles</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-activity.html">DiseasyActivity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-immunity-optimisation.html">DiseasyImmunity optimisation</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-immunity.html">DiseasyImmunity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-model-ode.html">DiseasyModelOde</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-model-regression.html">DiseasyModelRegression</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-observables.html">DiseasyObservables</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-season.html">DiseasySeason</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-variant.html">DiseasyVariant</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-implementation.html">SEIR: Implementation</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-initialisation.html">SEIR: Initialising from incidence data</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-malthusian-matching.html">SEIR: Accounting for structural differences in malthusian growth rates</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ssi-dk/diseasy/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>SEIR: Implementation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ssi-dk/diseasy/blob/main/vignettes/articles/SEIR-implementation.Rmd" class="external-link"><code>vignettes/articles/SEIR-implementation.Rmd</code></a></small>
      <div class="d-none name"><code>SEIR-implementation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette is a companion to the implementation of the SEIR ode
model <code>?DiseasyModelOdeSEIR</code>.</p>
<p>As the name suggests, this model is a SEIR-like ordinary differential
equation (ODE) model. Furthermore, the model is designed as flexible as
possible to allow for a wide range of different model configuration.
That is, the number of consecutive exposed, infected, and recovered
states can be set arbitrarily, as well as the number of age groups and
the number of variants.</p>
<p>Due to the flexibility of the model, the implementation is somewhat
complex, which is why we include this vignette outlining the
mathematical implementation of the model and connect it to the code.</p>
</div>
<div class="section level2">
<h2 id="opening-consideration">Opening consideration<a class="anchor" aria-label="anchor" href="#opening-consideration"></a>
</h2>
<p>The design of the SEIR model is meant to be “standard” in the sense
that it, in general, follows the structure and design of SEIR models in
the community.</p>
<p>For clarity, we here describe the considerations needed to design the
model.</p>
<div class="section level3">
<h3 id="indexes-and-accents">Indexes and accents<a class="anchor" aria-label="anchor" href="#indexes-and-accents"></a>
</h3>
<p>To begin, here we define a fixed meaning to the different indices and
accents used in the vignette:</p>
<table class="table">
<thead><tr class="header">
<th>Symbol</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>,</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">K,k</annotation></semantics></math></td>
<td>Exposed states</td>
</tr>
<tr class="even">
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>,</mo><mi>l</mi></mrow><annotation encoding="application/x-tex">L,l</annotation></semantics></math></td>
<td>Infected states</td>
</tr>
<tr class="odd">
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>,</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">M,m</annotation></semantics></math></td>
<td>Recovered states</td>
</tr>
<tr class="even">
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>,</mo><mi>i</mi><mo>,</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">A,i,j</annotation></semantics></math></td>
<td>Age groups</td>
</tr>
<tr class="odd">
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>,</mo><mi>a</mi><mo>,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">V,a,b</annotation></semantics></math></td>
<td>Variants</td>
</tr>
<tr class="even">
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi></mi><mo>∼</mo></msup><annotation encoding="application/x-tex">^\sim</annotation></semantics></math></td>
<td>Non-normalised quantity</td>
</tr>
</tbody>
</table>
<p>Where upper case letters denote the number of such elements and lower
case letters denote a specific element.</p>
</div>
<div class="section level3">
<h3 id="the-model-structure">The model structure<a class="anchor" aria-label="anchor" href="#the-model-structure"></a>
</h3>
<p>The SEIR model we are building is a compartmental model with (near)
arbitrary number of exposed, infected, and recovered compartments. The
model also supports multiple age groups and multiple variants.</p>
<p>We divide the model into different “tracks” with each track
implementing the disease progression for a group of individuals. That
is, if we have
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
age groups and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>
variants, we have
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">A \cdot V</annotation></semantics></math>
tracks which each start with the first exposed state (or the first
infected state if no exposed states are included in the model). As the
infection progresses within each individual, they are moved down the
track through infection and eventually into recovery.</p>
<p>Schematically, the model can be represented as in the figure
below:</p>
<div class="figure" style="text-align: center">
<img src="SEIR-implementation-model.png" class="r-plt" alt="SEIR model overview for a two variant model" width="120%"><p class="caption">
SEIR model overview for a two variant model
</p>
</div>
<p>This figure shows the disease progression for two variant tracks for
a single age group. The arrows in the figure indicates the infections in
the model within these tracks.</p>
</div>
<div class="section level3">
<h3 id="state-vector">State vector<a class="anchor" aria-label="anchor" href="#state-vector"></a>
</h3>
<p>Each “track” of infection is placed in sequence in the state vector,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\psi}</annotation></semantics></math>,
and increments first in age groups then in variants.</p>
<p>Finally, the susceptible states are placed at the end of the state
vector.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><mo>=</mo><mo stretchy="false" form="prefix">[</mo><munder><munder><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>E</mi><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>E</mi><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow><mi>K</mi></msubsup><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><msubsup><mi>I</mi><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>I</mi><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow><mi>L</mi></msubsup><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><msubsup><mi>R</mi><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>R</mi><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow><mi>M</mi></msubsup></mtd></mtr></mtable><mo accent="true">⏟</mo></munder><mtext mathvariant="normal">Age group 1, Variant 1</mtext></munder></mrow><annotation encoding="application/x-tex">
\overline{\psi} = [\underbrace{\begin{matrix} E_{1,1}^1\, \cdots \, E_{1,1}^K \;\;\; I_{1,1}^1 \, \cdots \, I_{1,1}^L \;\;\; R_{1,1}^1 \, \cdots \, R_{1,1}^M \end{matrix}}_{\text{Age group 1, Variant 1}}
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder><munder><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>E</mi><mrow><mn>2</mn><mo>,</mo><mn>1</mn></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>E</mi><mrow><mn>2</mn><mo>,</mo><mn>1</mn></mrow><mi>K</mi></msubsup><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><msubsup><mi>I</mi><mrow><mn>2</mn><mo>,</mo><mn>1</mn></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>I</mi><mrow><mn>2</mn><mo>,</mo><mn>1</mn></mrow><mi>L</mi></msubsup><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><msubsup><mi>R</mi><mrow><mn>2</mn><mo>,</mo><mn>1</mn></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>R</mi><mrow><mn>2</mn><mo>,</mo><mn>1</mn></mrow><mi>M</mi></msubsup></mtd></mtr></mtable><mo accent="true">⏟</mo></munder><mtext mathvariant="normal">Age group 2, Variant 1</mtext></munder><mspace width="0.278em"></mspace><mi>⋯</mi></mrow><annotation encoding="application/x-tex">
\underbrace{\begin{matrix} E_{2,1}^1 \, \cdots \, E_{2,1}^K \;\;\; I_{2,1}^1 \, \cdots \, I_{2,1}^L \;\;\; R_{2,1}^1 \, \cdots \, R_{2,1}^M \end{matrix}}_{\text{Age group 2, Variant 1}}
\; \cdots
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder><munder><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>E</mi><mrow><mi>A</mi><mo>,</mo><mi>V</mi></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>E</mi><mrow><mi>A</mi><mo>,</mo><mi>V</mi></mrow><mi>K</mi></msubsup><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><msubsup><mi>I</mi><mrow><mi>A</mi><mo>,</mo><mi>V</mi></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>I</mi><mrow><mi>A</mi><mo>,</mo><mi>V</mi></mrow><mi>L</mi></msubsup><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><msubsup><mi>R</mi><mrow><mi>A</mi><mo>,</mo><mi>V</mi></mrow><mn>1</mn></msubsup><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msubsup><mi>R</mi><mrow><mi>A</mi><mo>,</mo><mi>V</mi></mrow><mi>M</mi></msubsup></mtd></mtr></mtable><mo accent="true">⏟</mo></munder><mtext mathvariant="normal">Age group A, Variant V</mtext></munder><mspace width="0.278em"></mspace><mspace width="0.278em"></mspace><msub><mi>S</mi><mn>1</mn></msub><mspace width="0.167em"></mspace><mi>⋯</mi><mspace width="0.167em"></mspace><msub><mi>S</mi><mi>A</mi></msub><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">
\underbrace{\begin{matrix} E_{A,V}^1 \, \cdots \, E_{A,V}^K \;\;\; I_{A,V}^1 \, \cdots \, I_{A,V}^L \;\;\; R_{A,V}^1 \, \cdots \, R_{A,V}^M \end{matrix}}_{\text{Age group A, Variant V}}
\;\; S_1 \, \cdots \, S_A]
</annotation></semantics></math> NOTE: State vector uses normalised
(unit) populations.</p>
<p>Notice that the state vector elements are indexed by state-type,
state-index, age-index and variant-index:</p>
<div class="figure" style="text-align: center">
<img src="SEIR-implementation-index.png" class="r-plt" alt="Index guide for the state vector"><p class="caption">
Index guide for the state vector
</p>
</div>
</div>
<div class="section level3">
<h3 id="contact-matrix">Contact matrix<a class="anchor" aria-label="anchor" href="#contact-matrix"></a>
</h3>
<p>The contact matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mover><mi>C</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo accent="true">̃</mo></mover><annotation encoding="application/x-tex">\tilde{\overline{\overline{C}}}</annotation></semantics></math>,
is a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>×</mo><mi>A</mi></mrow><annotation encoding="application/x-tex">A \times A</annotation></semantics></math>
matrix. The elements
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>c</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\tilde{c}_{ij}</annotation></semantics></math>
can denotes the contacts from age group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
to age group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.
(It may be helpful to memorise as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>c</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mo>←</mo><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\tilde{c}_{i\leftarrow j}</annotation></semantics></math>)</p>
<p>In the model, these are normalised to the “per capita” contact matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>C</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{C}}</annotation></semantics></math>,
meaning that the elements are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mfrac><msub><mover><mi>c</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>N</mi><mi>j</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">c_{ij} = \frac{\tilde{c}_{ij}}{N_j}</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>N</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub><annotation encoding="application/x-tex">\tilde{N}_i</annotation></semantics></math>
is the population of age group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.</p>
<p>This way, when used in the model, the equations’ infections terms
becomes:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mover><mi>c</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mover><mi>N</mi><mo accent="true">̃</mo></mover><mi>j</mi></msub></mfrac><msub><mo>∑</mo><mi>l</mi></msub><msubsup><mi>I</mi><mi>j</mi><mi>l</mi></msubsup><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\frac{\tilde{c}_{ij}}{\tilde{N}_j} \sum_l I_j^l S_i</annotation></semantics></math>
and the equations can be normalised via the transformations
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>ψ</mi><mi>e</mi></msup><mo>=</mo><mfrac><msubsup><mover><mi>ψ</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><mi>e</mi></mrow><mi>e</mi></msubsup><msub><mover><mi>N</mi><mo accent="true">̃</mo></mover><mi>i</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\psi^e = \frac{\tilde{\psi}^e_{i|e}}{\tilde{N}_{i}}</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><mi>e</mi></mrow><annotation encoding="application/x-tex">i|e</annotation></semantics></math>
is the age group of element
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>e</mi><annotation encoding="application/x-tex">e</annotation></semantics></math>.</p>
<p>NOTE: Shouldn’t we then have
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mover><mi>c</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mover><mi>N</mi><mo accent="true">̃</mo></mover><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">c_{ij} = \tilde{c}_{ij} \tilde{N}_j</annotation></semantics></math>
instead?</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mi>I</mi><mo accent="true">̃</mo></mover><mo accent="true">̇</mo></mover><mo>=</mo><mover><mi>β</mi><mo accent="true">̃</mo></mover><mspace width="0.167em"></mspace><mover><mi>I</mi><mo accent="true">̃</mo></mover><mover><mi>S</mi><mo accent="true">̃</mo></mover><mo>−</mo><msub><mi>r</mi><mi>I</mi></msub><mover><mi>I</mi><mo accent="true">̃</mo></mover><mo>⇒</mo></mrow><annotation encoding="application/x-tex">
\dot{\tilde{I}} = \tilde{\beta}\, \tilde{I} \tilde{S} - r_I \tilde{I} \Rightarrow
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mover><mover><mi>I</mi><mo accent="true">̃</mo></mover><mo accent="true">̇</mo></mover><mi>N</mi></mfrac><mo>=</mo><mfrac><mrow><mover><mi>β</mi><mo accent="true">̃</mo></mover><mspace width="0.167em"></mspace><mover><mi>I</mi><mo accent="true">̃</mo></mover><mover><mi>S</mi><mo accent="true">̃</mo></mover></mrow><mi>N</mi></mfrac><mo>−</mo><mfrac><mrow><msub><mi>r</mi><mi>I</mi></msub><mover><mi>I</mi><mo accent="true">̃</mo></mover></mrow><mi>N</mi></mfrac><mo>⇒</mo></mrow><annotation encoding="application/x-tex">
\frac{\dot{\tilde{I}}}{N} = \frac{\tilde{\beta}\, \tilde{I} \tilde{S}}{N} - \frac{ r_I \tilde{I}}{N} \Rightarrow
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>I</mi><mo accent="true">̇</mo></mover><mo>=</mo><mover><mi>β</mi><mo accent="true">̃</mo></mover><mspace width="0.167em"></mspace><mi>I</mi><mover><mi>S</mi><mo accent="true">̃</mo></mover><mo>−</mo><msub><mi>r</mi><mi>I</mi></msub><mi>I</mi><mo>⇒</mo></mrow><annotation encoding="application/x-tex">
\dot{I} = \tilde{\beta}\, I \tilde{S} - r_I I \Rightarrow
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>I</mi><mo accent="true">̇</mo></mover><mo>=</mo><mi>N</mi><mover><mi>β</mi><mo accent="true">̃</mo></mover><mspace width="0.167em"></mspace><mi>I</mi><mfrac><mover><mi>S</mi><mo accent="true">̃</mo></mover><mi>N</mi></mfrac><mo>−</mo><msub><mi>r</mi><mi>I</mi></msub><mi>I</mi><mo>⇒</mo></mrow><annotation encoding="application/x-tex">
\dot{I} = N\tilde{\beta}\, I \frac{\tilde{S}}{N} - r_I I \Rightarrow
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>I</mi><mo accent="true">̇</mo></mover><mo>=</mo><munder><munder><mrow><mi>N</mi><mover><mi>β</mi><mo accent="true">̃</mo></mover></mrow><mo accent="true">⏟</mo></munder><mi>β</mi></munder><mspace width="0.167em"></mspace><mi>I</mi><mi>S</mi><mo>−</mo><msub><mi>r</mi><mi>I</mi></msub><mi>I</mi></mrow><annotation encoding="application/x-tex">
\dot{I} = \underbrace{N\tilde{\beta}}_{\beta}\, I S - r_I I
</annotation></semantics></math></p>
</div>
</div>
<div class="section level2">
<h2 id="the-implementation-of-the-right-hand-side-function">The implementation of the right-hand side function<a class="anchor" aria-label="anchor" href="#the-implementation-of-the-right-hand-side-function"></a>
</h2>
<p>With the opening considerations in mind, we can now describe the
implementation of the model. Below, we now link the implementation with
the underlying mathematical descriptions of the model.</p>
<p>The <code>?DiseasyModelOdeSEIR</code> model implements the
<code><a href=".{2}/reference/DiseasyModelOdeSEIR.html#active-bindings">$rhs</a></code> method which computes the rates
needed for the ODE solver. The evaluation of this right-hand side
function uses a few intermediate variables which are described
below.</p>
<div class="section level3">
<h3 id="the-infected-matrix">The <code>infected</code> matrix<a class="anchor" aria-label="anchor" href="#the-infected-matrix"></a>
</h3>
<p>In the computation of the right-hand side of the ODE, we have a
helper matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>I</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{I}}</annotation></semantics></math>
stored as <code>infected</code> in the implementation.</p>
<p>This
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>I</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{I}}</annotation></semantics></math>
matrix is a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">A \times V</annotation></semantics></math>
matrix with elements</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mi>I</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><munder><mo>∑</mo><mi>l</mi></munder><msubsup><mi>I</mi><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow><mi>l</mi></msubsup></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><munder><mo>∑</mo><mi>l</mi></munder><msubsup><mi>I</mi><mrow><mn>1</mn><mo>,</mo><mi>V</mi></mrow><mi>l</mi></msubsup></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><munder><mo>∑</mo><mi>l</mi></munder><msubsup><mi>I</mi><mrow><mi>A</mi><mo>,</mo><mn>1</mn></mrow><mi>l</mi></msubsup></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><munder><mo>∑</mo><mi>l</mi></munder><msubsup><mi>I</mi><mrow><mi>A</mi><mo>,</mo><mi>V</mi></mrow><mi>l</mi></msubsup></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{I}} = \begin{bmatrix}
\sum_l I^l_{1,1} &amp; \cdots &amp; \sum_l I^l_{1,V} \\
\vdots &amp; \ddots &amp; \vdots \\
\sum_l I^l_{A,1} &amp; \cdots &amp; \sum_l I^l_{A,V}
\end{bmatrix}
</annotation></semantics></math></p>
<p>That is, the element
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>i</mi><mrow><mi>a</mi><mo>,</mo><mi>v</mi></mrow></msub><annotation encoding="application/x-tex">i_{a, v}</annotation></semantics></math>
contains the sum of all infected compartments for the track associated
with age group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
and variant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>v</mi><annotation encoding="application/x-tex">v</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="the-infected_contact_rate-matrix">The <code>infected_contact_rate</code> matrix<a class="anchor" aria-label="anchor" href="#the-infected_contact_rate-matrix"></a>
</h3>
<p>During the right-hand side computation, we also have a helper matrix
<code>infected_contact_rate</code> which is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mi>C</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mspace width="0.278em"></mspace><mover><mover><mi>I</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover></mrow><annotation encoding="application/x-tex">\overline{\overline{C}}\; \overline{\overline{I}}</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mrow><mi>C</mi><mi>I</mi></mrow><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>=</mo><mover><mover><mi>C</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mspace width="0.278em"></mspace><mover><mover><mi>I</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mi>i</mi></mrow></msub><munder><mo>∑</mo><mi>l</mi></munder><msubsup><mi>I</mi><mrow><mi>i</mi><mo>,</mo><mn>1</mn></mrow><mi>l</mi></msubsup></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mi>i</mi></mrow></msub><munder><mo>∑</mo><mi>l</mi></munder><msubsup><mi>I</mi><mrow><mi>i</mi><mo>,</mo><mi>V</mi></mrow><mi>l</mi></msubsup></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>c</mi><mrow><mi>A</mi><mo>←</mo><mi>i</mi></mrow></msub><munder><mo>∑</mo><mi>l</mi></munder><msubsup><mi>I</mi><mrow><mi>i</mi><mo>,</mo><mn>1</mn></mrow><mi>l</mi></msubsup></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>c</mi><mrow><mi>A</mi><mo>←</mo><mi>i</mi></mrow></msub><munder><mo>∑</mo><mi>l</mi></munder><msubsup><mi>I</mi><mrow><mi>i</mi><mo>,</mo><mi>V</mi></mrow><mi>l</mi></msubsup></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{CI}} = \overline{\overline{C}}\; \overline{\overline{I}} = \begin{bmatrix}
\sum_i c_{1\leftarrow i} \sum_l I^l_{i,1} &amp; \cdots &amp; \sum_i c_{1\leftarrow i} \sum_l I^l_{i,V} \\
\vdots &amp; \ddots &amp; \vdots \\
\sum_i c_{A\leftarrow i} \sum_l I^l_{i,1} &amp; \cdots &amp; \sum_i c_{A\leftarrow i} \sum_l I^l_{i,V}
\end{bmatrix}
</annotation></semantics></math></p>
<p>That is, the element
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mrow><mo stretchy="true" form="prefix">(</mo><mover><mover><mrow><mi>C</mi><mi>I</mi></mrow><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>i</mi><mo>,</mo><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">(\overline{\overline{CI}})_{i, a}</annotation></semantics></math>
contains the rate of contact for age group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
with persons infected with variant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
across all age groups.</p>
</div>
<div class="section level3">
<h3 id="the-infection_rate-matrix">The <code>infection_rate</code> matrix<a class="anchor" aria-label="anchor" href="#the-infection_rate-matrix"></a>
</h3>
<p>Continuing the computation of the right-hand side, we have the
<code>infection_rate</code> matrix
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>T</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{T}}</annotation></semantics></math>)
which is the <code>infected_contact_rate</code>
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mrow><mi>C</mi><mi>I</mi></mrow><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{CI}}</annotation></semantics></math>)
adjusted for additional risk factors.</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma(t)</annotation></semantics></math>:
Multiplicative effect of season</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ϵ</mi><mi>a</mi></msub><annotation encoding="application/x-tex">\epsilon_a</annotation></semantics></math>:
Relative infectiousness of variant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Γ</mi><annotation encoding="application/x-tex">\Gamma</annotation></semantics></math>:
Overall infection rate scaling factor</li>
</ul>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mi>T</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>=</mo><mi>Γ</mi><mspace width="0.278em"></mspace><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.278em"></mspace><mover><mover><mi>ℰ</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>⊙</mo><mover><mover><mrow><mi>C</mi><mi>I</mi></mrow><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover></mrow><annotation encoding="application/x-tex">
\overline{\overline{T}} = \Gamma\;\sigma(t)\;\overline{\overline{\mathcal{E}}} \odot \overline{\overline{CI}}
</annotation></semantics></math></p>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>⊙</mo><annotation encoding="application/x-tex">\odot</annotation></semantics></math>
is the Hadamard product (element-wise multiplication), and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>ℰ</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{\mathcal{E}}}</annotation></semantics></math>
is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">A \times V</annotation></semantics></math>
matrix:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mi>ℰ</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mi>V</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mi>V</mi></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{\mathcal{E}}} = \begin{bmatrix}
\epsilon_1 &amp; \cdots &amp; \epsilon_V \\
\vdots &amp; \ddots &amp; \vdots \\
\epsilon_1 &amp; \cdots &amp; \epsilon_V
\end{bmatrix}
</annotation></semantics></math></p>
<p>NOTE: In the code,
<code>private$indexed_variant_infection_risk</code> is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>ℰ</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{\mathcal{E}}}</annotation></semantics></math>
in vector form.</p>
</div>
<div class="section level3">
<h3 id="the-infection_matrix">The <code>infection_matrix</code><a class="anchor" aria-label="anchor" href="#the-infection_matrix"></a>
</h3>
<p>For the final computation of infections of the right-hand side, we
construct the matrix <code>infection_matrix</code>
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>f</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{f}}</annotation></semantics></math>).</p>
<p>Since only
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
compartments are susceptible to infection, we need only to consider the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">RS</annotation></semantics></math>
states to compute the new infections in the model.</p>
<p>The new <code>infection_matrix</code> therefore does not need to
contain the <code>K</code> exposed states and the <code>L</code>
infected states, but only the <code>M</code> recovered states and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
susceptible states.</p>
<p>We are therefore interested in the reduced state vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><mrow><mi>R</mi><mi>S</mi></mrow></msup><annotation encoding="application/x-tex">\overline{\psi}^{RS}</annotation></semantics></math>
whose elements
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>e</mi><mo>*</mo></msup><annotation encoding="application/x-tex">e^*</annotation></semantics></math>
are the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
elements of the full state vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\psi}</annotation></semantics></math>.</p>
<p>We now create an intermediate matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>U</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{U}}</annotation></semantics></math>
by expanding the <code>infection_rate</code> matrix
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>T</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{T}}</annotation></semantics></math>)
to a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>V</mi><mo>⋅</mo><mi>M</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">A \cdot (V \cdot M + 1) \times V</annotation></semantics></math>
matrix by repeating the rows of the <code>infection_rate</code> matrix.
This repeating is done by matching the age group of the
<code>infection_rate</code> matrix to the age group of the reduced state
vector. Each element,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>e</mi><annotation encoding="application/x-tex">e</annotation></semantics></math>,
in the state vector,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ψ</mi><annotation encoding="application/x-tex">\psi</annotation></semantics></math>
has a corresponding age group which we can write as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><mi>e</mi></mrow><annotation encoding="application/x-tex">i|e</annotation></semantics></math>.</p>
<p>The intermediate matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>U</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{U}}</annotation></semantics></math>,
has a row for all states in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
compartments and column for each variant. The form is as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mi>U</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>t</mi><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><msubsup><mi>e</mi><mn>1</mn><mo>*</mo></msubsup><mo>,</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>t</mi><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><msubsup><mi>e</mi><mn>1</mn><mo>*</mo></msubsup><mo>,</mo><mi>V</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>t</mi><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><msubsup><mi>e</mi><mn>2</mn><mo>*</mo></msubsup><mo>,</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>t</mi><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><msubsup><mi>e</mi><mn>2</mn><mo>*</mo></msubsup><mo>,</mo><mi>V</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>t</mi><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><msubsup><mi>e</mi><mrow><mi>A</mi><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>V</mi><mo>⋅</mo><mi>M</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mo>*</mo></msubsup><mo>,</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>t</mi><mrow><mi>i</mi><mo stretchy="false" form="prefix">|</mo><msubsup><mi>e</mi><mrow><mi>A</mi><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>V</mi><mo>⋅</mo><mi>M</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mo>*</mo></msubsup><mo>,</mo><mi>V</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{U}} = \begin{bmatrix}
  t_{i|e^*_1, 1} &amp; \cdots &amp; t_{i|e^*_1, V} \\
  t_{i|e^*_2, 1} &amp; \cdots &amp; t_{i|e^*_2, V} \\
  \vdots &amp; \vdots &amp;\vdots \\
  t_{i|e^*_{A \cdot (V \cdot M + 1)}, 1} &amp; \cdots &amp; t_{i|e^*_{A \cdot (V \cdot M + 1)}, V} \\
\end{bmatrix}
</annotation></semantics></math></p>
<p>We now have a matrix, whose elements are the infection rate for each
variant matched to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
elements of the state vector.</p>
<p>In this space, we can now account for:</p>
<ul>
<li>The state specific infection risks (i.e. the reduced risk from being
infected previously / vaccinated)</li>
<li>The effect of cross-immunity between the variants</li>
</ul>
<p>That is, we need to construct the matrix that accounts for the waning
of immunity
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>)
and the cross-immunity factors
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>χ</mi><mrow><mi>a</mi><mo>←</mo><mi>b</mi></mrow></msub><annotation encoding="application/x-tex">\chi_{a\leftarrow b}</annotation></semantics></math>
(Variant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
infecting a person with immunity for variant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>).</p>
<p>All together, this is implemented via the immunity matrix
(<code>immunity_matrix</code>)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>ρ</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{\rho}}</annotation></semantics></math>
which is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>V</mi><mo>⋅</mo><mi>M</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">A \cdot (V \cdot M + 1) \times V</annotation></semantics></math>
matrix on the form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mi>ρ</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mn>1</mn><mo>←</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mn>1</mn><mo>←</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mn>1</mn><mo>←</mo><mi>V</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mn>1</mn><mo>←</mo><mi>V</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>V</mi><mo>←</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>V</mi><mo>←</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>V</mi><mo>←</mo><mi>V</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>V</mi><mo>←</mo><mi>V</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mover><mn>1</mn><mo accent="true">¯</mo></mover><mi>A</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mover><mn>1</mn><mo accent="true">¯</mo></mover><mi>A</mi></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{\rho}} = \begin{bmatrix}
  \begin{bmatrix}
    1 - \chi_{1\leftarrow 1} (1 - \overline{\gamma}) \\
    \vdots \\
    1 - \chi_{1\leftarrow 1} (1 - \overline{\gamma})
  \end{bmatrix}
  &amp; \cdots &amp;
  \begin{bmatrix}
    1 - \chi_{1\leftarrow V} (1 - \overline{\gamma}) \\
    \vdots \\
    1 - \chi_{1\leftarrow V} (1 - \overline{\gamma})
  \end{bmatrix} \\
  \vdots &amp; \ddots &amp; \vdots \\
  \begin{bmatrix}
    1 - \chi_{V\leftarrow 1} (1 - \overline{\gamma}) \\
    \vdots \\
    1 - \chi_{V\leftarrow 1} (1 - \overline{\gamma})
  \end{bmatrix}
  &amp; \cdots &amp;
  \begin{bmatrix}
    1 - \chi_{V\leftarrow V} (1 - \overline{\gamma}) \\
    \vdots \\
    1 - \chi_{V\leftarrow V} (1 - \overline{\gamma})
  \end{bmatrix} \\
  \overline{1}_A &amp; \cdots &amp; \overline{1}_A
\end{bmatrix}
</annotation></semantics></math></p>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mn>1</mn><mo accent="true">¯</mo></mover><mi>A</mi></msub><annotation encoding="application/x-tex">\overline{1}_A</annotation></semantics></math>
is a ones vector of length
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>.</p>
<p>In
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>ρ</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{\rho}}</annotation></semantics></math>,
the sub-matrices of the form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>a</mi><mo>←</mo><mi>b</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>a</mi><mo>←</mo><mi>b</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">
\begin{bmatrix}
  1 - \chi_{a\leftarrow b} (1 - \overline{\gamma}) \\
  \vdots \\
  1 - \chi_{a\leftarrow b} (1 - \overline{\gamma})
\end{bmatrix}
</annotation></semantics></math></p>
<p>are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mi>M</mi><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">A \cdot M \times 1</annotation></semantics></math>
matrices with repeated sub-matrices. That is,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>a</mi><mo>←</mo><mi>b</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">1 - \chi_{a\leftarrow b} (1 - \overline{\gamma})</annotation></semantics></math>
is a vector of length
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>
which is repeated for each age group, to form the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mi>M</mi><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">A \cdot M \times 1</annotation></semantics></math>
matrix.</p>
<p>In total, the matrix accounts for the cross-variant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>χ</mi><mrow><mi>a</mi><mo>←</mo><mi>b</mi></mrow></msub><annotation encoding="application/x-tex">\chi_{a\leftarrow b}</annotation></semantics></math>
reductions of immunity
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mover><mi>γ</mi><mo accent="true">¯</mo></mover></mrow><annotation encoding="application/x-tex">1-\overline{\gamma}</annotation></semantics></math>).</p>
<p>Finally, we can combine everything to the flow matrix:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mover><mi>f</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>=</mo><mover><mover><mi>ρ</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mo>⊙</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="postfix">|</mo></mtd><mtd columnalign="center" style="text-align: center"></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="postfix">|</mo></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msup><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><mrow><mi>R</mi><mi>S</mi></mrow></msup></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msup><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><mrow><mi>R</mi><mi>S</mi></mrow></msup></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="postfix">|</mo></mtd><mtd columnalign="center" style="text-align: center"></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="postfix">|</mo></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>⊙</mo><mover><mover><mi>U</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover></mrow><annotation encoding="application/x-tex">
\overline{\overline{f}} = \overline{\overline{\rho}} \odot
\begin{bmatrix}
  \vert &amp;  &amp; \vert \\
  \overline{\psi}^{RS} &amp; \cdots &amp; \overline{\psi}^{RS} \\
  \vert &amp;  &amp; \vert \\
\end{bmatrix} \odot
\overline{\overline{U}}
</annotation></semantics></math></p>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msup><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><mrow><mi>R</mi><mi>S</mi></mrow></msup></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msup><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><mrow><mi>R</mi><mi>S</mi></mrow></msup></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\overline{\psi}^{RS} &amp; \cdots &amp; \overline{\psi}^{RS}\end{bmatrix}</annotation></semantics></math>
is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>
repeats of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
elements of the state vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\psi}</annotation></semantics></math>.</p>
<p>This matrix contains, for each
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
element in the state vector, a row consisting of per-variant infectious
contacts between the corresponding compartment and the infected
population in the model. These elements account for every risk modifying
mechanism included in the model.</p>
<p>The row sums of this matrix is then equal to the loss from the
compartment due to infectious contacts. The sums by variant/age group
combination can also be extracted from the matrix to form the in-flow of
new infections to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mn>1</mn></msub><annotation encoding="application/x-tex">E_1</annotation></semantics></math>
compartments.</p>
</div>
</div>
<div class="section level2">
<h2 id="generator-matrix">Generator matrix<a class="anchor" aria-label="anchor" href="#generator-matrix"></a>
</h2>
<p>Beyond implementing the right-hand side of the ODE, we also implement
the generator matrix for the model.</p>
<p>The generator matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{G}}</annotation></semantics></math>,
is a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mi>V</mi><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>K</mi><mo>+</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mi>A</mi><mo>⋅</mo><mi>V</mi><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>K</mi><mo>+</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">A \cdot V \cdot (K+L) \times A \cdot V \cdot (K+L)</annotation></semantics></math>
matrix containing the dynamics of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
states under the assumption of static
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
states.</p>
<p>Formally, the generator matrix is the linearisation:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><msup><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><mrow><mi>E</mi><mi>I</mi></mrow></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><msup><mover><mi>ψ</mi><mo accent="true">¯</mo></mover><mrow><mi>E</mi><mi>I</mi></mrow></msup></mrow><annotation encoding="application/x-tex">
\frac{d\overline{\psi}^{EI}}{d t} = \overline{\overline{G}} \overline{\psi}^{EI}
</annotation></semantics></math></p>
<p>The matrix can be decomposed into two contributions:</p>
<ul>
<li>The transition matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>T</mi></msub><annotation encoding="application/x-tex">\overline{\overline{G}}_T</annotation></semantics></math>,
which is a bi-diagonal matrix containing the flow rates between
sequential compartments</li>
<li>The transmission matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>β</mi></msub><annotation encoding="application/x-tex">\overline{\overline{G}}_\beta</annotation></semantics></math>
which contains the flows stemming from infections.</li>
</ul>
<p>The transition matrix is block-diagonal and has the form (here for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K = 1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">L = 1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>+</mo><mi>V</mi><mo>&gt;</mo><mn>2</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">A + V &gt; 2)</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>T</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mo>−</mo><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable></mtd><mtd columnalign="center" style="text-align: center"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mo>−</mo><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable></mtd><mtd columnalign="center" style="text-align: center"><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mo>−</mo><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{G}}_T =
\left[\begin{array}{cccc}
  \begin{bmatrix}
    -r_e &amp; 0 \\
    r_e &amp; -r_i
  \end{bmatrix} &amp;
  \begin{matrix}
    0 &amp; 0 \\
    0 &amp; 0
  \end{matrix} &amp;
  \cdots &amp;
  \begin{matrix}
    0 &amp; 0 \\
    0 &amp; 0
  \end{matrix} \\
  \begin{matrix}
    0 &amp; 0 \\
    0 &amp; 0
  \end{matrix} &amp;
  \begin{bmatrix}
    -r_e &amp; 0 \\
    r_e &amp; -r_i
  \end{bmatrix} &amp;
  \cdots &amp;
  \begin{matrix}
    0 &amp; 0 \\
    0 &amp; 0
  \end{matrix} \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  \begin{matrix}
    0 &amp; 0 \\
    0 &amp; 0
  \end{matrix} &amp;
  \begin{matrix}
    0 &amp; 0 \\
    0 &amp; 0
  \end{matrix} &amp;
  \cdots &amp;
  \begin{bmatrix}
    -r_e &amp; 0 \\
    r_e &amp; -r_i
  \end{bmatrix}
\end{array}\right]
</annotation></semantics></math></p>
<p>Notice that the off-diagonal has zero-elements where the (reduced)
state vector changes age groups
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>I</mi><mi>i</mi><mi>L</mi></msubsup><mo>→</mo><msubsup><mi>E</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">I_i^L \rightarrow E_{i+1}^1</annotation></semantics></math>).</p>
<p>The form of the transmission matrix is more difficult to write
up.</p>
<p>We lump risk modifying factors such as the effect of season
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma(t)</annotation></semantics></math>
and overall infection rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Γ</mi><annotation encoding="application/x-tex">\Gamma</annotation></semantics></math>
into a single factor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>.</p>
<p>Some examples:</p>
<div class="section level4">
<h4 id="double-age-group-single-variant">Double age group, single variant<a class="anchor" aria-label="anchor" href="#double-age-group-single-variant"></a>
</h4>
<p>As long as we have only a single variant, cross immunity can be
ignored and we can lump the effect of the balance between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
into
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>.</p>
<p>For
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K = 1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">L = 1</annotation></semantics></math>,
the transmission matrix is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>β</mi></msub><mo>=</mo><mi>β</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{G}}_\beta = \beta
\begin{bmatrix}
  0 &amp; c_{1\leftarrow 1} &amp; 0 &amp; c_{1\leftarrow 2} \\
  0 &amp; 0 &amp; 0 &amp; 0 \\
  0 &amp; c_{2\leftarrow 1} &amp; 0 &amp; c_{2\leftarrow 2} \\
  0 &amp; 0 &amp; 0 &amp; 0
\end{bmatrix}
</annotation></semantics></math></p>
<p>For
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K = 1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">L = 2</annotation></semantics></math>,
the transmission matrix is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>β</mi></msub><mo>=</mo><mi>β</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{G}}_\beta = \beta
\begin{bmatrix}
  0 &amp; c_{1\leftarrow 1} &amp; c_{1\leftarrow 1} &amp; 0 &amp; c_{1\leftarrow 2} &amp; c_{1\leftarrow 2} \\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
  0 &amp; c_{2\leftarrow 1} &amp; c_{2\leftarrow 1} &amp; 0 &amp; c_{2\leftarrow 2} &amp; c_{2\leftarrow 2} \\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0
\end{bmatrix}
</annotation></semantics></math></p>
</div>
<div class="section level4">
<h4 id="single-age-group-double-variant">Single age group, double variant<a class="anchor" aria-label="anchor" href="#single-age-group-double-variant"></a>
</h4>
<p>With only one age group, the contact matrix is the scalar
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>.</p>
<p>With two variants, we need to also account for the relative
infectivity of the variants
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ϵ</mi><mi>a</mi></msub><annotation encoding="application/x-tex">\epsilon_a</annotation></semantics></math>.</p>
<p>Then, for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K = 1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">L = 1</annotation></semantics></math>,
the transmission matrix is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>β</mi></msub><mo>=</mo><mi>β</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mn>1</mn></msub><mspace width="0.167em"></mspace><mi>c</mi></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>+</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>2</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mn>2</mn></msub><mspace width="0.167em"></mspace><mi>c</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{G}}_\beta = \beta\left[
\begin{array}{ccccc}
  0 &amp; \epsilon_1\hat{\rho}_{1}\,c &amp; | &amp; 0 &amp; 0 \\
  0 &amp; 0 &amp; | &amp; 0 &amp; 0 \\
  - &amp; - &amp; + &amp; - &amp; - \\
  0 &amp; 0 &amp; | &amp; 0 &amp; \epsilon_2\hat{\rho}_{2}\,c \\
  0 &amp; 0 &amp; | &amp; 0 &amp; 0
\end{array}
\right]
</annotation></semantics></math></p>
<p>Where the change between variants is demarcated visually by the
vertical and horizontal lines. We now have the additional factor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\rho}</annotation></semantics></math>
which explicitly accounts for the balance of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
states and the cross-immunity between the variants:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mi>a</mi></msub><mo>=</mo><mi>S</mi><mo>+</mo><munderover><mo>∑</mo><mrow><mi>b</mi><mo>=</mo><mn>1</mn></mrow><mi>V</mi></munderover><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>b</mi><mo>←</mo><mi>a</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>γ</mi><mi>m</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>R</mi><mi>b</mi><mi>m</mi></msubsup></mrow><annotation encoding="application/x-tex">
\hat{\rho}_{a} = S + \sum_{b = 1}^V\sum_{m=1}^M \left(1 - \chi_{b \leftarrow a}(1 - \gamma_m)\right) R^m_b
</annotation></semantics></math></p>
<p>That is, we have the unmodified contribution from the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
states, and the contribution from all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
states while accounting for waning of immunity
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\gamma_m</annotation></semantics></math>)
and cross-immunity
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>χ</mi><mrow><mi>a</mi><mo>←</mo><mi>b</mi></mrow></msub><annotation encoding="application/x-tex">\chi_{a \leftarrow b}</annotation></semantics></math>).</p>
<p>This factor is analogous to a “cross-section” of infection encounter,
i.e. a factor that accounts for the probability that a contact between
an infectious and non-infected person is an infectious contact.</p>
<p>Then, for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K = 1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">L = 2</annotation></semantics></math>,
the transmission matrix is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>β</mi></msub><mo>=</mo><mi>β</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mn>1</mn></msub><mspace width="0.167em"></mspace><mi>c</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mn>1</mn></msub><mspace width="0.167em"></mspace><mi>c</mi></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>+</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>2</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mn>2</mn></msub><mspace width="0.167em"></mspace><mi>c</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>2</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mn>2</mn></msub><mspace width="0.167em"></mspace><mi>c</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{G}}_\beta = \beta\left[
\begin{array}{ccccccc}
  0 &amp; \epsilon_1\hat{\rho}_{1}\,c &amp; \epsilon_1\hat{\rho}_{1}\,c &amp; | &amp; 0 &amp; 0 &amp; 0 \\
  0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; 0 &amp; 0 \\
  0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; 0 &amp; 0 \\
  - &amp; - &amp; - &amp; + &amp; - &amp; - &amp; - \\
  0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; \epsilon_2\hat{\rho}_{2}\,c &amp; \epsilon_2\hat{\rho}_{2}\,c \\
  0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; 0 &amp; 0 \\
  0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; 0 &amp; 0 \\
\end{array}
\right]
</annotation></semantics></math></p>
</div>
<div class="section level4">
<h4 id="double-age-group-double-variant">Double age group, double variant<a class="anchor" aria-label="anchor" href="#double-age-group-double-variant"></a>
</h4>
<p>When including age groups, the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\rho}</annotation></semantics></math>
factor becomes a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">A \times V</annotation></semantics></math>
matrix of elements</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mo>,</mo><mi>a</mi></mrow></msub><mo>=</mo><msub><mi>S</mi><mi>i</mi></msub><mo>+</mo><munderover><mo>∑</mo><mrow><mi>b</mi><mo>=</mo><mn>1</mn></mrow><mi>V</mi></munderover><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>χ</mi><mrow><mi>b</mi><mo>←</mo><mi>a</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>γ</mi><mi>m</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>R</mi><mrow><mi>i</mi><mo>,</mo><mi>b</mi></mrow><mi>m</mi></msubsup></mrow><annotation encoding="application/x-tex">
\hat{\rho}_{i, a} = S_i + \sum_{b = 1}^V\sum_{m=1}^M \left(1 - \chi_{b \leftarrow a}(1 - \gamma_m)\right) R^m_{i,b}
</annotation></semantics></math></p>
<p>For
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K = 1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">L = 1</annotation></semantics></math>,
the transmission matrix is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mover><mi>G</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>β</mi></msub><mo>=</mo><mi>β</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow></msub><mspace width="0.167em"></mspace><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mn>1</mn><mo>,</mo><mn>1</mn></mrow></msub><mspace width="0.167em"></mspace><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mn>2</mn><mo>,</mo><mn>1</mn></mrow></msub><mspace width="0.167em"></mspace><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>1</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mn>2</mn><mo>,</mo><mn>1</mn></mrow></msub><mspace width="0.167em"></mspace><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>+</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>2</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mn>1</mn><mo>,</mo><mn>2</mn></mrow></msub><mspace width="0.167em"></mspace><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>2</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mn>1</mn><mo>,</mo><mn>2</mn></mrow></msub><mspace width="0.167em"></mspace><msub><mi>c</mi><mrow><mn>1</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>2</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mn>2</mn><mo>,</mo><mn>2</mn></mrow></msub><mspace width="0.167em"></mspace><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>ϵ</mi><mn>2</mn></msub><msub><mover><mi>ρ</mi><mo accent="true">̂</mo></mover><mrow><mn>2</mn><mo>,</mo><mn>2</mn></mrow></msub><mspace width="0.167em"></mspace><msub><mi>c</mi><mrow><mn>2</mn><mo>←</mo><mn>2</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo stretchy="false" form="prefix">|</mo></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{G}}_\beta = \beta\left[
\begin{array}{cccccccc}
  0 &amp; \epsilon_1\hat{\rho}_{1,1}\,c_{1\leftarrow 1} &amp; 0 &amp; \epsilon_1\hat{\rho}_{1,1}\,c_{1\leftarrow 2} &amp; | &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
  0 &amp; \epsilon_1\hat{\rho}_{2,1}\,c_{2\leftarrow 1} &amp; 0 &amp; \epsilon_1\hat{\rho}_{2,1}\,c_{2\leftarrow 2} &amp; | &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
  - &amp; - &amp; - &amp; - &amp; + &amp; - &amp; - &amp; - &amp; - \\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; \epsilon_2\hat{\rho}_{1,2}\,c_{1\leftarrow 1} &amp; 0 &amp; \epsilon_2\hat{\rho}_{1,2}\,c_{1\leftarrow 2} \\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; \epsilon_2\hat{\rho}_{2,2}\,c_{2\leftarrow 1} &amp; 0 &amp; \epsilon_2\hat{\rho}_{2,2}\,c_{2\leftarrow 2} \\
  0 &amp; 0 &amp; 0 &amp; 0 &amp; | &amp; 0 &amp; 0 &amp; 0 &amp; 0
\end{array}
\right]
</annotation></semantics></math></p>
</div>
</div>
<div class="section level2">
<h2 id="notes-on-optimisations-of-the-right-hand-side-function">Notes on optimisations of the right-hand side function<a class="anchor" aria-label="anchor" href="#notes-on-optimisations-of-the-right-hand-side-function"></a>
</h2>
<p>It is important that the implementation is somewhat optimised for the
simulations to run in reasonable time. To that end, we here show
micro-benchmarks of different implementations of the same steps to
highlight why a given implementation was chosen.</p>
<p>These benchmarks assume a simple SEIR model with only tree age group
and one variant.</p>
<div class="section level3">
<h3 id="infected-sum-computation">“infected” sum computation<a class="anchor" aria-label="anchor" href="#infected-sum-computation"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Step 1, determine the number of infected by age group and variant</span></span>
<span><span class="va">i_state_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">state_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">9</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Benchmark possible approaches</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span> <span class="co"># Microseconds</span></span>
<span>  <span class="st">"purrr::map_dbl"</span> <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span></span>
<span>    <span class="va">i_state_indices</span>,</span>
<span>    \<span class="op">(</span><span class="va">indices</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">state_vector</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"sapply"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>    <span class="va">i_state_indices</span>,</span>
<span>    \<span class="op">(</span><span class="va">indices</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">state_vector</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"sapply - USE.NAMES"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>    <span class="va">i_state_indices</span>,</span>
<span>    \<span class="op">(</span><span class="va">indices</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">state_vector</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"vapply"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>    <span class="va">i_state_indices</span>,</span>
<span>    \<span class="op">(</span><span class="va">indices</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">state_vector</span><span class="op">[</span><span class="va">indices</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="st">"equal"</span>, times <span class="op">=</span> <span class="fl">1000L</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Unit: microseconds</span></span>
<span><span class="co">#&gt;                expr    min      lq      mean  median      uq      max neval</span></span>
<span><span class="co">#&gt;      purrr::map_dbl 21.717 22.4900 23.513116 22.7900 23.3095   97.015  1000</span></span>
<span><span class="co">#&gt;              sapply 11.115 11.5550 12.128401 11.8855 12.2820   23.444  1000</span></span>
<span><span class="co">#&gt;  sapply - USE.NAMES 11.189 11.5775 14.212789 11.8765 12.2730 1957.428  1000</span></span>
<span><span class="co">#&gt;              vapply  4.334  4.6430  4.919972  4.7720  4.9430   17.801  1000</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rasmus Skytte Randløv, Marcus Munch Grünewald, Lasse Engbo Christiansen, Kaare Græsbøll, Sofia Myrup Otero, <a href="https://www.ssi.dk/" class="external-link"><img src="https://www.ssi.dk/assets/images/ssi-logo-optimeret.svg" alt="SSI" height="64" style="margin-bottom: 0.5em; margin-top: 1.5em;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
