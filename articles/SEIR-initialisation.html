<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>SEIR: Initialising from incidence data • diseasy</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="SEIR: Initialising from incidence data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">diseasy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/diseasy.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Creating ensembles</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-ensembles.html">Creating ensembles</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Functional modules</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasy-activity.html">DiseasyActivity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-immunity.html">DiseasyImmunity</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-observables.html">DiseasyObservables</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-season.html">DiseasySeason</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-variant.html">DiseasyVariant</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Model templates</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasy-model-ode.html">DiseasyModelOde</a></li>
    <li><a class="dropdown-item" href="../articles/diseasy-model-regression.html">DiseasyModelRegression</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Developer guides</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-a-model.html">Creating a model</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Model notes</h6></li>
    <li><a class="dropdown-item" href="../articles/SEIR-implementation.html">SEIR: Implementation</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-initialisation.html">SEIR: Initialising from incidence data</a></li>
    <li><a class="dropdown-item" href="../articles/SEIR-malthusian-matching.html">SEIR: Accounting for structural differences in malthusian growth rates</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Additional information</h6></li>
    <li><a class="dropdown-item" href="../articles/diseasy-immunity-optimisation.html">DiseasyImmunity optimisation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ssi-dk/diseasy/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>SEIR: Initialising from incidence data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ssi-dk/diseasy/blob/main/vignettes/articles/SEIR-initialisation.Rmd" class="external-link"><code>vignettes/articles/SEIR-initialisation.Rmd</code></a></small>
      <div class="d-none name"><code>SEIR-initialisation.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ssi-dk/diseasy" class="external-link">diseasy</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: diseasystore</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'diseasy'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:diseasystore':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     diseasyoption</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Let us begin by considering a general SEIR model with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
consecutive
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
states respectively, which are governed by the rates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>r</mi><mi>e</mi></msub><annotation encoding="application/x-tex">r_e</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>r</mi><mi>i</mi></msub><annotation encoding="application/x-tex">r_i</annotation></semantics></math>
respectively.</p>
<p>Let us further assume that we have a incidence signal<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The signal we eventually inside
&lt;code&gt;?DiseasyModelOdeSeir$initialise_state_vector()&lt;/code&gt; is computed
from the incidence rate. There is a small but important difference
between the incidence rate and the signal need for initialisation,
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;msup&gt;&lt;mi&gt;I&lt;/mi&gt;&lt;mo&gt;*&lt;/mo&gt;&lt;/msup&gt;&lt;mrow&gt;&lt;mo stretchy="true" form="prefix"&gt;(&lt;/mo&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mo stretchy="true" form="postfix"&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;annotation encoding="application/x-tex"&gt;I^*(t)&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;.
Specifically,
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;msup&gt;&lt;mi&gt;I&lt;/mi&gt;&lt;mo&gt;*&lt;/mo&gt;&lt;/msup&gt;&lt;mrow&gt;&lt;mo stretchy="true" form="prefix"&gt;(&lt;/mo&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mo stretchy="true" form="postfix"&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;annotation encoding="application/x-tex"&gt;I^*(t)&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;
should be the number of true infections in the group divided by the
total population not the group population.&lt;/p&gt;'><sup>1</sup></a>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>I</mi><mo>*</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I^*(t)</annotation></semantics></math>,
which we would like our model to match.</p>
<p>The general approach is to consider the derivatives of the incidence
and link these to the states of the model.</p>
</div>
<div class="section level2">
<h2 id="initialising-ei-states">Initialising EI states<a class="anchor" aria-label="anchor" href="#initialising-ei-states"></a>
</h2>
<p>The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mi>I</mi></mrow><annotation encoding="application/x-tex">EI</annotation></semantics></math>
states of the SEIR model should match the most recent developments of
the incidence.</p>
<p>For this purpose, we assume that signal occurs when exiting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mn>1</mn></msub><annotation encoding="application/x-tex">I_1</annotation></semantics></math>
in the model.</p>
<p>That is, we assume
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>I</mi><mo>*</mo></msup><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>I</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">I^* = r_i I_1</annotation></semantics></math>.</p>
<p>If we take the equation for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mn>1</mn></msub><annotation encoding="application/x-tex">I_1</annotation></semantics></math>
and multiply by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>r</mi><mi>i</mi></msub><annotation encoding="application/x-tex">r_i</annotation></semantics></math>
we obtain.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msub><mi>I</mi><mn>1</mn></msub></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mi>K</mi></msub><mo>−</mo><msubsup><mi>r</mi><mi>i</mi><mn>2</mn></msubsup><msub><mi>I</mi><mn>1</mn></msub><mo>⇒</mo></mrow><annotation encoding="application/x-tex">
r_i\frac{d I_1}{d t} = r_i r_e E_K - r_i^2 I_1 \Rightarrow
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mi>K</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><msup><mi>I</mi><mo>*</mo></msup></mrow><annotation encoding="application/x-tex">
\frac{d I^*}{d t} = r_i r_e E_K - r_i I^*
</annotation></semantics></math></p>
<p>If we take the second derivative, we find:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msup><mi>d</mi><mn>2</mn></msup><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub><mfrac><mrow><mi>d</mi><msub><mi>E</mi><mi>K</mi></msub></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msub><mi>I</mi><mi>l</mi></msub></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\frac{d^2I^*}{d t^2} = r_i r_e \frac{d E_K}{d t} - r_i \frac{d I_l}{d t}
</annotation></semantics></math> From here, we can inject
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><mi>d</mi><msub><mi>E</mi><mi>K</mi></msub></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><annotation encoding="application/x-tex">\frac{d E_K}{d t}</annotation></semantics></math>
from the SEIR equations which in turn relates to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><annotation encoding="application/x-tex">E_{k-1}</annotation></semantics></math>.
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msup><mi>d</mi><mn>2</mn></msup><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mrow><mi>K</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msub><mi>I</mi><mi>l</mi></msub></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\frac{d^2I^*}{d t^2} = r_i r_e \left(r_e E_{K-1} - r_e E_K\right) - r_i \frac{d I_l}{d t}
</annotation></semantics></math></p>
<p>This process can be iterated through the derivatives until all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mi>K</mi></msub><annotation encoding="application/x-tex">E_K</annotation></semantics></math>
states are expressed in terms of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>I</mi><mo>*</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I^*(t)</annotation></semantics></math>
and its derivatives.</p>
<p>In this case, we can relate the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mi>k</mi></msub><annotation encoding="application/x-tex">E_k</annotation></semantics></math>
states to the rates and derivatives of the signal in a simple form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mi>K</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>r</mi><mi>e</mi><mn>2</mn></msubsup><msub><mi>E</mi><mrow><mi>K</mi><mo>−</mo><mn>1</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>…</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>r</mi><mi>e</mi><mrow><mi>K</mi><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mi>E</mi><mn>2</mn></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>r</mi><mi>e</mi><mi>K</mi></msubsup><msub><mi>E</mi><mn>1</mn></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><msub><mover><mover><mi>M</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mi>K</mi></msub><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msup><mi>I</mi><mo>*</mo></msup></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>…</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mfrac><mrow><msup><mi>d</mi><mi>K</mi></msup><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><msup><mi>t</mi><mi>K</mi></msup></mrow></mfrac></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mfrac><mrow><msup><mi>d</mi><mrow><mi>K</mi><mo>+</mo><mn>1</mn></mrow></msup><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><msup><mi>t</mi><mrow><mi>K</mi><mo>+</mo><mn>1</mn></mrow></msup></mrow></mfrac></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
r_i
\begin{bmatrix}
r_e E_K \\
r_e^2 E_{K-1} \\
\dots \\
r_e^{K-1} E_2 \\
r_e^K E_1 \\
\end{bmatrix}
=
\overline{\overline{M}}_K \cdot
\begin{bmatrix}
I^* \\
\frac{d I^*}{d t} \\
\dots \\
\frac{d^K I^*}{d t^K} \\
\frac{d^{K+1}I^*}{d t^{K+1}}
\end{bmatrix}
</annotation></semantics></math></p>
<p>The matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mover><msub><mi>M</mi><mi>K</mi></msub><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{M_K}}</annotation></semantics></math>
can be computed via a simple recursion.</p>
<p>To see why, start the equation for the derivative of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>I</mi><mo>*</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I^*(t)</annotation></semantics></math>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mi>K</mi></msub><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><msup><mi>I</mi><mo>*</mo></msup></mrow><annotation encoding="application/x-tex">
\frac{d I^*}{d t} = r_i r_e E_K - r_i I^*
</annotation></semantics></math></p>
<p>And separating the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mi>k</mi></msub><annotation encoding="application/x-tex">E_k</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mo>*</mo></mrow><annotation encoding="application/x-tex">I*</annotation></semantics></math>
terms:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mi>K</mi></msub><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msup><mi>I</mi><mo>*</mo></msup><mo>+</mo><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
r_i r_e E_K = r_i I^* + \frac{d I^*}{d t}
</annotation></semantics></math></p>
<p>In the above formulation, this corresponds to the matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mover><mi>M</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mn>1</mn></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\overline{\overline{M}}_1 = \begin{bmatrix}r_i &amp; 1\end{bmatrix}</annotation></semantics></math>.</p>
<p>When taking the second derivative, we obtain:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msup><mi>d</mi><mn>2</mn></msup><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub><mfrac><mrow><mi>d</mi><msub><mi>E</mi><mi>K</mi></msub></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>⇒</mo></mrow><annotation encoding="application/x-tex">
\frac{d^2I^*}{d t^2} = r_i r_e \frac{d E_K}{d t}- r_i \frac{d I^*}{d t} \Rightarrow
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msup><mi>d</mi><mn>2</mn></msup><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mrow><mi>K</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>r</mi><mi>e</mi></msub><msub><mi>E</mi><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>⇒</mo></mrow><annotation encoding="application/x-tex">
\frac{d^2I^*}{d t^2} = r_i r_e \left(r_e E_{K-1} - r_e E_K\right) - r_i \frac{d I^*}{d t} \Rightarrow
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msup><mi>d</mi><mn>2</mn></msup><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msubsup><mi>r</mi><mi>e</mi><mn>2</mn></msubsup><msub><mi>E</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>r</mi><mi>e</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>+</mo><msup><mi>I</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\frac{d^2I^*}{d t^2} = r_i r_e^2 E_{k-1} - r_e\left(r_i \frac{d I^*}{d t} + I^*\right)- r_i \frac{d I^*}{d t}
</annotation></semantics></math></p>
<p>And separating the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mi>k</mi></msub><annotation encoding="application/x-tex">E_k</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mo>*</mo></mrow><annotation encoding="application/x-tex">I*</annotation></semantics></math>
terms:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub><msubsup><mi>r</mi><mi>e</mi><mn>2</mn></msubsup><msub><mi>E</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>r</mi><mi>e</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>+</mo><msup><mi>I</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub><mfrac><mrow><mi>d</mi><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>+</mo><mfrac><mrow><msup><mi>d</mi><mn>2</mn></msup><msup><mi>I</mi><mo>*</mo></msup></mrow><mrow><mi>d</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">
r_i r_e^2 E_{k-1} = r_e\left(r_i \frac{d I^*}{d t} + I^*\right) + r_i \frac{d I^*}{d t} + \frac{d^2I^*}{d t^2}
</annotation></semantics></math></p>
<p>Which, in the matrix formulation corresponds to the sum of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>e</mi></msub><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">r_e \overline{m}_1</annotation></semantics></math>
and the shifted
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mn>1</mn></msub><annotation encoding="application/x-tex">\overline{m}_1</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mn>1</mn></msub><annotation encoding="application/x-tex">\overline{m}_1</annotation></semantics></math>
is the row vector of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><msub><mover><mi>M</mi><mo accent="true">¯</mo></mover><mn>1</mn></msub><mo accent="true">¯</mo></mover><annotation encoding="application/x-tex">\overline{\overline{M}_1}</annotation></semantics></math>.</p>
<p>That is, we can express the second derivative as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mn>2</mn></msub><mo>=</mo><msub><mi>r</mi><mi>e</mi></msub><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mn>1</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mn>1</mn></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{m}_2 = r_e \begin{bmatrix}\overline{m}_1 &amp; 0 \end{bmatrix}+ \begin{bmatrix}0 &amp; \overline{m}_1\end{bmatrix}
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
= \begin{bmatrix}r_i r_e &amp; r_e &amp; 0 \end{bmatrix} + \begin{bmatrix}0 &amp; r_i &amp; 1 \end{bmatrix}
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>e</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
= \begin{bmatrix}r_i r_e &amp; r_e + r_i &amp; 1 \end{bmatrix}
</annotation></semantics></math></p>
<p>Which, combined with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mn>1</mn></msub><annotation encoding="application/x-tex">\overline{m}_1</annotation></semantics></math>
yields the two level system:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mover><mi>M</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mn>2</mn></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>m</mi><mn>11</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>m</mi><mn>12</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>m</mi><mn>21</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>m</mi><mn>22</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>m</mi><mn>23</mn></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\overline{\overline{M}}_2 = \begin{bmatrix}m_{11} &amp; m_{12} &amp; 0 \\ m_{21} &amp; m_{22} &amp; m_{23} \end{bmatrix}
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>i</mi></msub><msub><mi>r</mi><mi>e</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>e</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">
= \begin{bmatrix} r_i &amp; 1 &amp; 0 \\ r_i r_e &amp; r_e + r_i &amp; 1 \end{bmatrix}
</annotation></semantics></math></p>
<p>In general, the rows can be computed by recursion:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mi>k</mi></msub><mo>=</mo><msub><mi>r</mi><mi>e</mi></msub><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mover><mi>m</mi><mo accent="true">¯</mo></mover><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mspace width="1.0em"></mspace><msub><mover><mover><mi>m</mi><mo accent="true">¯</mo></mover><mo accent="true">¯</mo></mover><mn>1</mn></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>r</mi><mi>i</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\overline{m}_{k} = r_e \begin{bmatrix}
  \overline{m}_{k-1} &amp; 0
\end{bmatrix} +
\begin{bmatrix}
  0 &amp; \overline{m}_{k-1}
\end{bmatrix}\quad
\overline{\overline{m}}_1 = \begin{bmatrix}r_i &amp; 1\end{bmatrix}.
</annotation></semantics></math></p>
<p>The algorithmic implementation of the recursion is then:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">ri</span> <span class="op">&lt;-</span> <span class="fl">0.9</span></span>
<span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fl">0.8</span></span>
<span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">K</span> <span class="op">*</span> <span class="op">(</span><span class="va">K</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">K</span><span class="op">)</span> <span class="co"># Pre-allocate</span></span>
<span><span class="va">active_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ri</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">k</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">active_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">active_row</span><span class="op">)</span> <span class="op">+</span> <span class="va">re</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">active_row</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">M</span><span class="op">[</span><span class="va">k</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">k</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">active_row</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">M</span></span>
<span><span class="co">#&gt;        [,1] [,2] [,3] [,4] [,5]</span></span>
<span><span class="co">#&gt; [1,] 0.9000 1.00 0.00  0.0    0</span></span>
<span><span class="co">#&gt; [2,] 0.7200 1.70 1.00  0.0    0</span></span>
<span><span class="co">#&gt; [3,] 0.5760 2.08 2.50  1.0    0</span></span>
<span><span class="co">#&gt; [4,] 0.4608 2.24 4.08  3.3    1</span></span></code></pre></div>
<p>Since we assume that the signal
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>I</mi><mo>*</mo></msup><annotation encoding="application/x-tex">I^*</annotation></semantics></math>
only relates to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mn>1</mn></msub><annotation encoding="application/x-tex">I_1</annotation></semantics></math>,
then we can determine the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mrow><mi>l</mi><mo>&gt;</mo><mn>1</mn></mrow></msub><annotation encoding="application/x-tex">I_{l&gt;1}</annotation></semantics></math>
states by evaluating the signal at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>I</mi><mo>*</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I^*(t - (l - 1) / r_i)</annotation></semantics></math>.</p>
</div>
<div class="section level2">
<h2 id="initialising-sr-states">Initialising SR states<a class="anchor" aria-label="anchor" href="#initialising-sr-states"></a>
</h2>
<p>The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>R</mi></mrow><annotation encoding="application/x-tex">SR</annotation></semantics></math>
states of the SEIR model should capture both the short and the long term
developments of the incidence signal we want to match. If a lot of
infections have happened previously, we expect a larger proportion of
the population to be in the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
states.</p>
<p>We again assume
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>I</mi><mo>*</mo></msup><mo>=</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>I</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">I^* = r_i I_1</annotation></semantics></math>.</p>
<p>We can modify the SEIR equation to take this signal as a forcing
function with no
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
states and one less
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
state (no
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mn>1</mn></msub><annotation encoding="application/x-tex">I_1</annotation></semantics></math>
state).</p>
<p>The equations are as normal expect for the following changes:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mo>=</mo><mfrac><msup><mi>I</mi><mo>*</mo></msup><msub><mi>r</mi><mi>i</mi></msub></mfrac><mo>+</mo><munderover><mo>∑</mo><mrow><mi>l</mi><mo>=</mo><mn>2</mn></mrow><mi>L</mi></munderover><msub><mi>I</mi><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">
I = \frac{I^*}{r_i} + \sum_{l=2}^L I_l
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><msub><mi>I</mi><mn>2</mn></msub></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><msup><mi>I</mi><mo>*</mo></msup><mo>−</mo><msub><mi>r</mi><mi>i</mi></msub><msub><mi>I</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">
\frac{d I_2}{d t} = I^* - r_i I_2
</annotation></semantics></math> If we start this system at a time where
there are no new infections, we can initialize
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>l</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">I_l = 0</annotation></semantics></math>,
and run the simulation forward to estimate the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
populations at the point of interest.</p>
</div>
<div class="section level2">
<h2 id="testing-the-methods">Testing the methods<a class="anchor" aria-label="anchor" href="#testing-the-methods"></a>
</h2>
<p>We test the initialisation methods on a data set generated using the
same <code><a href="../reference/DiseasyModelOdeSeir.html">?DiseasyModelOdeSeir</a></code> model template that we are using
in this vignette.</p>
<div class="section level3">
<h3 id="simple-seir-example-data">Simple SEIR example data<a class="anchor" aria-label="anchor" href="#simple-seir-example-data"></a>
</h3>
<p>For the first example, we use the SEIR model output where we know the
parameters of the model used to generate the data.</p>
<p>To begin, we configure the observables module to use this data set
and to use all available data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Connect to a database</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/DiseasyObservables.html">DiseasyObservables</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  diseasystore <span class="op">=</span> <span class="va">DiseasystoreSeirExample</span>,</span>
<span>  conn <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">obs</span><span class="op">$</span><span class="fu">set_study_period</span><span class="op">(</span> <span class="co"># Use all available data</span></span>
<span>  start_date <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">ds</span><span class="op">$</span><span class="va">min_start_date</span>,</span>
<span>  end_date <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">ds</span><span class="op">$</span><span class="va">max_end_date</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The data set contains different data for the infected to test our
initialisation method against.</p>
<p>The data are:</p>
<ul>
<li>“n_infected”: The true number of infected in the model, measured as
the number of people transitioning out of the <code>I1</code> state at
any given date.</li>
<li>“n_positive_simple”: A realisation of the number of test-positives
in the model - using a 65 % probability of testing.</li>
<li>“n_positive”: A realisation of the number of test-positives in the
model - using a overall 65 % probability of testing in conjunction with
a reduced probability of testing during weekends.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n_infected"</span>, <span class="st">"n_positive_simple"</span>, <span class="st">"n_positive"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">observable</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">obs</span><span class="op">$</span><span class="fu">get_observation</span><span class="op">(</span></span>
<span>      observable <span class="op">=</span> <span class="va">observable</span>,</span>
<span>      stratification <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quos</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="op">~</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">.y</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"age_group"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="st">"variant"</span> <span class="op">=</span> <span class="st">"WT"</span>, .after <span class="op">=</span> <span class="st">"age_group"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 450 × 6</span></span></span>
<span><span class="co">#&gt;    date       age_group variant n_infected n_positive_simple n_positive</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2020-01-03 30-59     WT            64.2                37         41</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2020-01-04 30-59     WT           136.                 85         64</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2020-01-05 30-59     WT           179.                107         79</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2020-01-06 30-59     WT           203.                136        138</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2020-01-07 30-59     WT           221.                137        144</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2020-01-08 30-59     WT           239.                159        169</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2020-01-09 30-59     WT           257.                170        181</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2020-01-10 30-59     WT           278.                188        196</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2020-01-11 30-59     WT           301.                203        159</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2020-01-12 30-59     WT           326.                199        143</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 440 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualise the example data</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">model_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">n_infected</span>, color <span class="op">=</span> <span class="st">"Infected"</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">n_positive</span>, color <span class="op">=</span> <span class="st">"Test positive (realistic)"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">n_positive_simple</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"Test positive (simple)"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">age_group</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Test positive / Infected"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Infected"</span>                  <span class="op">=</span> <span class="st">"deepskyblue3"</span>,</span>
<span>      <span class="st">"Test positive (simple)"</span>    <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>      <span class="st">"Test positive (realistic)"</span> <span class="op">=</span> <span class="st">"seagreen"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Model output"</span><span class="op">)</span></span></code></pre></div>
<p><img src="SEIR-initialisation_files/figure-html/example%20data-1.png" class="r-plt" alt="Plots of the example data bundled with diseasy." width="700"></p>
<p>These different levels of detail allows us to test the initialisation
from incidence data in different cases.</p>
<p>The method relies on having incidence data, so we scale the model
outputs by the population size. We do this by creating a “synthetic”
observable in the observables module.</p>
<p>The simplest cases is using the “n_infected” signal which directly
tracks the <code>I1</code> state in the model. While the most realistic
case is the “n_positive” signal which has some real life inspired noise
patterns.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">source</span> <span class="op">&lt;-</span> <span class="st">"n_positive"</span></span>
<span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"n_infected"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mapping</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">n_infected</span>, <span class="va">n_population</span><span class="op">)</span> <span class="va">n_infected</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_population</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"n_positive_simple"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mapping</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">n_positive_simple</span>, <span class="va">n_population</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n_positive_simple</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_population</span> <span class="op">*</span> <span class="fl">0.65</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"n_positive"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mapping</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">n_positive</span>, <span class="va">n_population</span><span class="op">)</span> <span class="va">n_positive</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_population</span> <span class="op">*</span> <span class="fl">0.65</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">obs</span><span class="op">$</span><span class="fu">define_synthetic_observable</span><span class="op">(</span><span class="st">"incidence"</span>, <span class="va">mapping</span><span class="op">)</span></span>
<span></span>
<span><span class="va">incidence_data</span> <span class="op">&lt;-</span> <span class="va">obs</span><span class="op">$</span><span class="fu">get_observation</span><span class="op">(</span></span>
<span>  observable <span class="op">=</span> <span class="st">"incidence"</span>,</span>
<span>  stratification <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">quos</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="st">"source"</span> <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">source</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="correctly-specified-model">Correctly specified model<a class="anchor" aria-label="anchor" href="#correctly-specified-model"></a>
</h4>
<p>In any case, we first need to define the model that should initialise
using the incidence data. We here use the model configuration used to
generate the data to test the best case scenario:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set the point in time to initialise from</span></span>
<span><span class="va">obs</span><span class="op">$</span><span class="fu">set_last_queryable_date</span><span class="op">(</span><span class="va">obs</span><span class="op">$</span><span class="va">start_date</span> <span class="op">+</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">45</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">generate_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">K</span>, <span class="va">L</span>, <span class="va">M</span>, <span class="va">rE</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">2.1</span>, <span class="va">rI</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">4.5</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Define the activity for the scenario</span></span>
<span>  <span class="va">act</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/DiseasyActivity.html">DiseasyActivity</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">act</span><span class="op">$</span><span class="fu">set_contact_basis</span><span class="op">(</span>contact_basis <span class="op">=</span> <span class="va">contact_basis</span><span class="op">$</span><span class="va">DK</span><span class="op">)</span></span>
<span>  <span class="va">act</span><span class="op">$</span><span class="fu">set_activity_units</span><span class="op">(</span><span class="va">dk_activity_units</span><span class="op">)</span></span>
<span>  <span class="va">act</span><span class="op">$</span><span class="fu">change_activity</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"1900-01-01"</span><span class="op">)</span>, opening <span class="op">=</span> <span class="st">"baseline"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create a SEIR model to initialise</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/DiseasyModelOdeSeir.html">DiseasyModelOdeSeir</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    observables <span class="op">=</span> <span class="va">obs</span>,</span>
<span>    activity <span class="op">=</span> <span class="va">act</span>,</span>
<span>    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"compartment_structure"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"E"</span> <span class="op">=</span> <span class="va">K</span>, <span class="st">"I"</span> <span class="op">=</span> <span class="va">L</span>, <span class="st">"R"</span> <span class="op">=</span> <span class="va">M</span><span class="op">)</span>,</span>
<span>      <span class="st">"age_cuts_lower"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span>, <span class="fl">60</span><span class="op">)</span>,</span>
<span>      <span class="st">"overall_infection_risk"</span> <span class="op">=</span> <span class="fl">0.025</span>,</span>
<span>      <span class="st">"disease_progression_rates"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"E"</span> <span class="op">=</span> <span class="va">rE</span>, <span class="st">"I"</span> <span class="op">=</span> <span class="va">rI</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">generate_model</span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span> <span class="co"># Use the configuration from example data</span></span></code></pre></div>
<p>This method relies on fitting a polynomial to the latest period, so
we here visualise this fitting.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract the most recent signal</span></span>
<span><span class="va">poly_fit_data</span> <span class="op">&lt;-</span> <span class="va">incidence_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="st">"t"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">date</span> <span class="op">-</span> <span class="op">!</span><span class="op">!</span><span class="va">obs</span><span class="op">$</span><span class="va">last_queryable_date</span>, units <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">poly_fit_projection</span> <span class="op">&lt;-</span> <span class="va">poly_fit_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">age_group</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html" class="external-link">group_modify</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span> <span class="op">{</span></span>
<span>      <span class="va">poly_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span></span>
<span>        <span class="va">incidence</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">m</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">incidence_polynomial_order</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>          <span class="va">.x</span>,</span>
<span>          <span class="va">.data</span><span class="op">$</span><span class="va">t</span> <span class="op">&lt;=</span> <span class="fl">0</span>,</span>
<span>          <span class="va">.data</span><span class="op">$</span><span class="va">t</span> <span class="op">&gt;=</span> <span class="op">-</span> <span class="va">m</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">incidence_polynomial_training_length</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>        <span class="st">"t"</span> <span class="op">=</span> <span class="va">.x</span><span class="op">$</span><span class="va">t</span>,</span>
<span>        <span class="st">"incidence"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">poly_fit</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"t"</span> <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="st">"date"</span> <span class="op">=</span> <span class="va">.x</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">incidence_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">incidence</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>      color <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>        <span class="va">source</span>,</span>
<span>        <span class="st">"n_infected"</span>        <span class="op">=</span> <span class="st">"deepskyblue3"</span>,</span>
<span>        <span class="st">"n_positive_simple"</span> <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>        <span class="st">"n_positive"</span>        <span class="op">=</span> <span class="st">"seagreen"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">poly_fit_projection</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>      xintercept <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">last_queryable_date</span>,</span>
<span>      linetype <span class="op">=</span> <span class="fl">2</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"red"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>      xintercept <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">last_queryable_date</span> <span class="op">-</span></span>
<span>        <span class="va">m</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">incidence_polynomial_training_length</span>,</span>
<span>      linetype <span class="op">=</span> <span class="fl">2</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"red"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span></span>
<span>      <span class="fl">0</span>,</span>
<span>      <span class="va">incidence_data</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="st">"incidence"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1.1</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">age_group</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 169 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="SEIR-initialisation_files/figure-html/incidence%20fitting-1.png" class="r-plt" alt="Fitting a polynomial to the incidence data to estimate derivatives." width="700"></p>
<p>We can now use the
<code><a href=".{2}/reference/DiseasyModelOdeSeir.html#method-DiseasyModelOdeSeir-initialise_state_vector">$initialise_state_vector()</a></code> method to
infer the initial state vector.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">psi</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">$</span><span class="fu">initialise_state_vector</span><span class="op">(</span><span class="va">incidence_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">psi</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 15 × 4</span></span></span>
<span><span class="co">#&gt;    variant age_group state initial_condition</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> All     00-29     E1             0.001<span style="text-decoration: underline;">47</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> All     00-29     E2             0.001<span style="text-decoration: underline;">41</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> All     00-29     I1             0.004<span style="text-decoration: underline;">84</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> All     00-29     R1             0.013<span style="text-decoration: underline;">2</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> All     30-59     E1             0.001<span style="text-decoration: underline;">23</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> All     30-59     E2             0.001<span style="text-decoration: underline;">18</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> All     30-59     I1             0.004<span style="text-decoration: underline;">10</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> All     30-59     R1             0.011<span style="text-decoration: underline;">2</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> All     60+       E1             0.000<span style="text-decoration: underline;">413</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> All     60+       E2             0.000<span style="text-decoration: underline;">398</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> All     60+       I1             0.001<span style="text-decoration: underline;">39</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> All     60+       R1             0.003<span style="text-decoration: underline;">79</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> <span style="color: #BB0000;">NA</span>      00-29     S              0.337   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> <span style="color: #BB0000;">NA</span>      30-59     S              0.368   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> <span style="color: #BB0000;">NA</span>      60+       S              0.250</span></span></code></pre></div>
<p>And we now test the initial conditions by solving the model using
these starting conditions.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_prediction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">model</span>,</span>
<span>    <span class="va">psi</span>,</span>
<span>    <span class="va">signal</span> <span class="op">=</span> <span class="st">"incidence"</span></span>
<span>  <span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Integrate the ODE system with deSolve</span></span>
<span>  <span class="va">sol</span> <span class="op">&lt;-</span> <span class="fu">deSolve</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/deSolve/man/ode.html" class="external-link">ode</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="va">psi</span><span class="op">$</span><span class="va">initial_condition</span>,</span>
<span>    times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>    func <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">rhs</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Improve the names of the output</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sol</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"time"</span>,</span>
<span>    <span class="va">psi</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html" class="external-link">unite</a></span><span class="op">(</span><span class="st">"label"</span>, <span class="st">"variant"</span>, <span class="st">"age_group"</span>, <span class="st">"state"</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="st">"label"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Convert to long format</span></span>
<span>  <span class="va">sol_long</span> <span class="op">&lt;-</span> <span class="va">sol</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      <span class="op">!</span><span class="st">"time"</span>,</span>
<span>      names_sep <span class="op">=</span> <span class="st">"/"</span>,</span>
<span>      names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"variant"</span>, <span class="st">"age_group"</span>, <span class="st">"state"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract the solution</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">signal</span> <span class="op">==</span> <span class="st">"incidence"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">sol_long</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">state</span> <span class="op">==</span> <span class="st">"I1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="st">"state"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        <span class="st">"date"</span> <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">time</span> <span class="op">+</span> <span class="va">model</span><span class="op">$</span><span class="va">observables</span><span class="op">$</span><span class="va">last_queryable_date</span>,</span>
<span>        <span class="st">"incidence_model"</span> <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">disease_progression_rates</span><span class="op">[[</span><span class="st">"I"</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span></span>
<span>            <span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">compartment_structure</span><span class="op">[[</span><span class="st">"I"</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span></span>
<span>            <span class="va">.data</span><span class="op">$</span><span class="va">value</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Convert to incidence</span></span>
<span>    <span class="va">proportion</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="va">activity</span><span class="op">$</span><span class="fu">map_population</span><span class="op">(</span></span>
<span>      <span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">age_cuts_lower</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        <span class="st">"age_group"</span> <span class="op">=</span> <span class="fu">diseasystore</span><span class="fu">::</span><span class="fu"><a href="https://ssi-dk.github.io/diseasystore/reference/age_labels.html">age_labels</a></span><span class="op">(</span></span>
<span>          <span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">age_cuts_lower</span></span>
<span>        <span class="op">)</span><span class="op">[</span><span class="va">.data</span><span class="op">$</span><span class="va">age_group_out</span><span class="op">]</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>        <span class="st">"proportion"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">proportion</span><span class="op">)</span>,</span>
<span>        .by <span class="op">=</span> <span class="st">"age_group"</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">proportion</span>, by <span class="op">=</span> <span class="st">"age_group"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="st">"incidence_model"</span> <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">incidence_model</span> <span class="op">/</span> <span class="va">.data</span><span class="op">$</span><span class="va">proportion</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="st">"proportion"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">signal</span> <span class="op">==</span> <span class="st">"prevalence"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">sol_long</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">state</span>, <span class="st">"I1"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="st">"state"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>        <span class="st">"date"</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span> <span class="op">+</span> <span class="va">model</span><span class="op">$</span><span class="va">observables</span><span class="op">$</span><span class="va">last_queryable_date</span>,</span>
<span>        <span class="st">"incidence_model"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>,</span>
<span>        .by <span class="op">=</span> <span class="st">"time"</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Add the model configuration</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      <span class="st">"model_configuration"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">compartment_structure</span><span class="op">)</span>,</span>
<span>        <span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">compartment_structure</span>,</span>
<span>        collapse <span class="op">=</span> <span class="st">""</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu">get_prediction</span><span class="op">(</span>model <span class="op">=</span> <span class="va">m</span>, psi <span class="op">=</span> <span class="va">psi</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 153 × 7</span></span></span>
<span><span class="co">#&gt;     time variant age_group   value date       incidence_model</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     0 All     00-29     0.004<span style="text-decoration: underline;">84</span> 2020-02-17         0.003<span style="text-decoration: underline;">02</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     0 All     30-59     0.004<span style="text-decoration: underline;">10</span> 2020-02-17         0.002<span style="text-decoration: underline;">36</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     0 All     60+       0.001<span style="text-decoration: underline;">39</span> 2020-02-17         0.001<span style="text-decoration: underline;">20</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1 All     00-29     0.005<span style="text-decoration: underline;">12</span> 2020-02-18         0.003<span style="text-decoration: underline;">19</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1 All     30-59     0.004<span style="text-decoration: underline;">33</span> 2020-02-18         0.002<span style="text-decoration: underline;">49</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1 All     60+       0.001<span style="text-decoration: underline;">47</span> 2020-02-18         0.001<span style="text-decoration: underline;">27</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     2 All     00-29     0.005<span style="text-decoration: underline;">46</span> 2020-02-19         0.003<span style="text-decoration: underline;">41</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     2 All     30-59     0.004<span style="text-decoration: underline;">62</span> 2020-02-19         0.002<span style="text-decoration: underline;">66</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     2 All     60+       0.001<span style="text-decoration: underline;">57</span> 2020-02-19         0.001<span style="text-decoration: underline;">35</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     3 All     00-29     0.005<span style="text-decoration: underline;">86</span> 2020-02-20         0.003<span style="text-decoration: underline;">65</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 143 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: model_configuration &lt;chr&gt;</span></span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">incidence_data</span>,</span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">incidence</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>      <span class="va">source</span>,</span>
<span>      <span class="st">"n_infected"</span>        <span class="op">=</span> <span class="st">"deepskyblue3"</span>,</span>
<span>      <span class="st">"n_positive_simple"</span> <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>      <span class="st">"n_positive"</span>        <span class="op">=</span> <span class="st">"seagreen"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">prediction</span>,</span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">incidence_model</span>, color <span class="op">=</span> <span class="va">model_configuration</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    xintercept <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">last_queryable_date</span>,</span>
<span>    linetype <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">source</span> <span class="op">~</span> <span class="va">age_group</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Model output"</span>, color <span class="op">=</span> <span class="st">"Model Configuration"</span><span class="op">)</span></span></code></pre></div>
<p><img src="SEIR-initialisation_files/figure-html/correctly%20specified%20model-1.png" class="r-plt" alt="Using a correctly specified model to initialise the SEIR model matches the true data near-perfectly." width="700"></p>
</div>
<div class="section level4">
<h4 id="misspecified-model">Misspecified model<a class="anchor" aria-label="anchor" href="#misspecified-model"></a>
</h4>
<p>Correctly matching the model is the best case scenario. However, we
can also the method for a couple of cases where the model is
misspecified.</p>
<p>Note that we at this state does not modify the parameters of the
model to match the development, we only estimate the initial state
vector.</p>
<p>Once we include model fitting, the discrepancy between the data and
model predictions may diminish.</p>
<div class="section level5">
<h5 id="misspecified-model-in-periods-of-increasing-infections">Misspecified model in periods of increasing infections<a class="anchor" aria-label="anchor" href="#misspecified-model-in-periods-of-increasing-infections"></a>
</h5>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">generate_model</span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  <span class="fu">generate_model</span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  <span class="fu">generate_model</span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>  <span class="fu">generate_model</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">2L</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="va">models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">get_prediction</span><span class="op">(</span>model <span class="op">=</span> <span class="va">m</span>, psi <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="fu">initialise_state_vector</span><span class="op">(</span><span class="va">incidence_data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="va">rbind</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">incidence_data</span>,</span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">incidence</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>      <span class="va">source</span>,</span>
<span>      <span class="st">"n_infected"</span>        <span class="op">=</span> <span class="st">"deepskyblue3"</span>,</span>
<span>      <span class="st">"n_positive_simple"</span> <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>      <span class="st">"n_positive"</span>        <span class="op">=</span> <span class="st">"seagreen"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">predictions</span>,</span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">incidence_model</span>, color <span class="op">=</span> <span class="va">model_configuration</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    xintercept <span class="op">=</span> <span class="va">models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">observables</span><span class="op">$</span><span class="va">last_queryable_date</span>,</span>
<span>    linetype <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">source</span> <span class="op">~</span> <span class="va">age_group</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Model output"</span>, color <span class="op">=</span> <span class="st">"Model Configuration"</span><span class="op">)</span></span></code></pre></div>
<p><img src="SEIR-initialisation_files/figure-html/misspecified%20model%20increasing-1.png" class="r-plt" alt="Using a misspecified model to initialise the SEIR model can match the true data well when infections are increasing." width="700"></p>
</div>
<div class="section level5">
<h5 id="misspecified-model-in-periods-of-decreasing-infections">Misspecified model in periods of decreasing infections<a class="anchor" aria-label="anchor" href="#misspecified-model-in-periods-of-decreasing-infections"></a>
</h5>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">generate_model</span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  <span class="fu">generate_model</span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  <span class="fu">generate_model</span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>  <span class="fu">generate_model</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">2L</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Update the last queryable date to later starting point</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">walk</a></span><span class="op">(</span><span class="va">models</span>, \<span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">m</span><span class="op">$</span><span class="va">observables</span><span class="op">$</span><span class="fu">set_last_queryable_date</span><span class="op">(</span></span>
<span>    <span class="va">m</span><span class="op">$</span><span class="va">observables</span><span class="op">$</span><span class="va">ds</span><span class="op">$</span><span class="va">max_end_date</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">45</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="va">models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">get_prediction</span><span class="op">(</span>model <span class="op">=</span> <span class="va">m</span>, psi <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="fu">initialise_state_vector</span><span class="op">(</span><span class="va">incidence_data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="va">rbind</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">incidence_data</span>,</span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">incidence</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>      <span class="va">source</span>,</span>
<span>      <span class="st">"n_infected"</span>        <span class="op">=</span> <span class="st">"deepskyblue3"</span>,</span>
<span>      <span class="st">"n_positive_simple"</span> <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>      <span class="st">"n_positive"</span>        <span class="op">=</span> <span class="st">"seagreen"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">predictions</span>,</span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">incidence_model</span>, color <span class="op">=</span> <span class="va">model_configuration</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    xintercept <span class="op">=</span> <span class="va">models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">observables</span><span class="op">$</span><span class="va">last_queryable_date</span>,</span>
<span>    linetype <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">source</span> <span class="op">~</span> <span class="va">age_group</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Model output"</span>, color <span class="op">=</span> <span class="st">"Model Configuration"</span><span class="op">)</span></span></code></pre></div>
<p><img src="SEIR-initialisation_files/figure-html/misspecified%20model%20decreasing-1.png" class="r-plt" alt="Using a misspecified model to initialise the SEIR model can match the true data well when infections are decreasing." width="700"></p>
</div>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rasmus Skytte Randløv, Marcus Munch Grünewald, Lasse Engbo Christiansen, Kaare Græsbøll, Sofia Myrup Otero, <a href="https://www.ssi.dk/" class="external-link"><img src="https://www.ssi.dk/assets/images/ssi-logo-optimeret.svg" alt="SSI" height="64" style="margin-bottom: 0.5em; margin-top: 1.5em;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
